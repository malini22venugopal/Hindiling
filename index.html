<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>рд╣рд┐рдВрджреА рдСрдбрд┐рдпреЛ рдХреНрд╡рд┐рдЬрд╝ тАФ рд▓рд┐рдВрдЧ & рд╡рдЪрди</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
<style>
  body{font-family:'Noto Sans Devanagari',sans-serif;background:#fffdf9;margin:0;padding:20px;color:#111}
  h1{color:#b71c1c;text-align:center;margin:6px 0 18px;font-size:1.9rem}
  .center{max-width:760px;margin:0 auto;padding:12px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:12px}
  button{border:none;padding:10px 14px;border-radius:8px;font-size:1rem;cursor:pointer}
  button.blue{background:#1565c0;color:#fff;box-shadow:0 2px 0 rgba(0,0,0,0.08)}
  button.gray{background:#6c757d;color:#fff}
  input[type=text]{width:100%;padding:12px;border-radius:8px;border:1px solid #ccc;font-size:1rem;box-sizing:border-box}
  #question{text-align:left;font-size:1.6rem;margin:18px 0 8px}
  #translation{color:#666;margin-bottom:8px}
  #feedback{min-height:28px;margin-top:12px;font-weight:700}
  #feedback.correct{color:#0b5;display:inline-block}
  #feedback.wrong{color:#c00;display:inline-block}
  .note{color:#b71c1c;margin-top:18px;font-weight:700}
  .small{font-size:0.9rem;color:#666;margin-top:12px;text-align:center}
  #loginModal{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:999}
  .loginBox{background:#fff;padding:20px;border-radius:10px;max-width:360px;width:90%;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,0.2)}
  .loginBox input{margin:8px 0}
  #logoutBtn{background:#b71c1c;color:#fff;margin-top:12px;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;}
</style>
</head>
<body>
<div class="center">
<h1>рд╣рд┐рдВрджреА рдСрдбрд┐рдпреЛ рдХреНрд╡рд┐рдЬрд╝ тАФ рд▓рд┐рдВрдЧ & рд╡рдЪрди</h1>

<!-- Login Modal -->
<div id="loginModal">
  <div class="loginBox">
    <h3>рд▓реЙрдЧрд┐рди рдХрд░реЗрдВ</h3>
    <input id="loginName" type="text" placeholder="рдЕрдкрдирд╛ рдирд╛рдо рд▓рд┐рдЦреЗрдВ (Name)">
    <div style="margin-top:10px">
      <button id="loginBtn" class="blue">рдкреНрд░рд╡реЗрд╢ рдХрд░реЗрдВ</button>
    </div>
    <p id="loginMsg" style="color:#c00;margin-top:10px"></p>
    <p style="font-size:0.9rem;color:#666;margin-top:12px">рдПрдХ рдмрд╛рд░ рдкреВрд░рд╛ рдХрд░рдиреЗ рдкрд░ рд╡рд╣реА рдирд╛рдо рдЙрд╕реА рдмреНрд░рд╛рдЙрдЬрд╝рд░/рдбрд┐рд╡рд╛рдЗрд╕ рд╕реЗ рдлрд┐рд░ рд╕реЗ рдХреНрд╡рд┐рдЬрд╝ рдирд╣реАрдВ рджреЗ рдкрд╛рдПрдЧрд╛ред</p>
  </div>
</div>

<!-- Quiz Area -->
<div id="quizArea" style="display:none">
  <div id="question">рдХреНрд╡рд┐рдЬрд╝ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП "рд╢реБрд░реВ рдХрд░реЗрдВ" рджрдмрд╛рдПрдБ</div>
  <div id="translation">(Listen and answer)</div>
  <input id="answerInput" type="text" placeholder="рдЙрддреНрддрд░ рдмреЛрд▓рд┐рдП рдпрд╛ рд▓рд┐рдЦрд┐рдП (Enter рд╕реЗ рдЬрд╛рдБрдЪреЗрдВ)">
  <div class="controls">
    <button id="startBtn" class="blue">тЦ╢я╕П рд╢реБрд░реВ рдХрд░реЗрдВ</button>
    <button id="resetBtn" class="gray">ЁЯФБ рд░реАрд╕реЗрдЯ</button>
    <button id="speakBtn" class="blue">ЁЯОд рдмреЛрд▓реЗрдВ</button>
    <button id="passBtn" class="gray">тПн рдкрд╛рд╕</button>
    <button id="replayBtn" class="gray">ЁЯФБ рдлрд┐рд░ рд╕реБрдиреЗрдВ</button>
    <button id="checkBtn" class="blue">тЬЕ рдЬрд╛рдБрдЪреЗрдВ</button>
  </div>
  <div id="feedback"></div>
  <div id="score" class="small"></div>
  <button id="logoutBtn">ЁЯФТ рд▓реЙрдЧрдЖрдЙрдЯ рдФрд░ рд░рд┐рдкреЛрд░реНрдЯ рднреЗрдЬреЗрдВ</button>
  <p class="note" id="voiceWarn" style="display:none">ЁЯФ┤ рдЖрдкрдХреЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдореЗрдВ рд╣рд┐рдВрджреА рдЖрд╡рд╛рдЬрд╝ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд░рд╣реА рд╣реИред рдХреГрдкрдпрд╛ Chrome рдпрд╛ Edge рдореЗрдВ рдЦреЛрд▓реЗрдВред</p>
  <p class="small">Chrome (desktop / HTTPS / localhost) рдкрд░ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ тАФ рдкрд╣рд▓реА рдмрд╛рд░ рдорд╛рдЗрдХреНрд░реЛрдлрд╝реЛрди рдЕрдиреБрдорддрд┐ рджреЗрдВред</p>
</div>
</div>

<script>
/* ===========================
   Replace these before hosting
   =========================== */
const APPS_SCRIPT_URL = "YOUR_APPS_SCRIPT_WEBAPP_URL";
const WHATSAPP_PHONE = "919994895676";

/* ---------------- Questions ---------------- */
const vachanQuestions = [
  { word: "рд▓рддрд╛", answers:["рд▓рддрд╛рдПрдБ","рд▓рддрд╛рдПрдВ"] },
  { word: "рдорд╛рд▓рд╛", answers:["рдорд╛рд▓рд╛рдПрдБ","рдорд╛рд▓рд╛рдПрдВ"] },
  { word: "рдорд╛рддрд╛", answers:["рдорд╛рддрд╛рдПрдБ","рдорд╛рддрд╛рдПрдВ"] },
  { word: "рдкрд╛рдард╢рд╛рд▓рд╛", answers:["рдкрд╛рдард╢рд╛рд▓рд╛рдПрдБ","рдкрд╛рдард╢рд╛рд▓рд╛рдПрдВ"] },
  { word: "рдХрд▓рд╛", answers:["рдХрд▓рд╛рдПрдБ","рдХрд▓рд╛рдПрдВ"] },
  { word: "рдмрд╛рд▓рд╛", answers:["рдмрд╛рд▓рд╛рдПрдБ","рдмрд╛рд▓рд╛реЗрдВ"] },
  { word: "рдмреБрджреНрдзрд┐рдпрд╛", answers:["рдмреБрджреНрдзрд┐рдпрд╛рдБ","рдмреБрджреНрдзрд┐рдпрд╛рдВ"] },
  { word: "рдЪрд┐рдбрд╝рд┐рдпрд╛", answers:["рдЪрд┐рдбрд╝рд┐рдпрд╛рдБ","рдЪрд┐рдбрд╝рд┐рдпрд╛рдПрдВ"] },
  { word: "рдЧреБрдбрд╝рд┐рдпрд╛", answers:["рдЧреБрдбрд╝рд┐рдпрд╛рдПрдБ","рдЧреБрдбрд╝рд┐рдпрд╛рдВ"] },
  { word: "рд▓рдбрд╝рдХреА", answers:["рд▓рдбрд╝рдХрд┐рдпрд╛рдБ","рд▓рдбрд╝рдХрд┐рдпрд╛рдВ"] },
  { word: "рдирджреА", answers:["рдирджрд┐рдпрд╛рдБ","рдирджрд┐рдпрд╛рдВ"] },
  { word: "рдЧрд▓реА", answers:["рдЧрд▓рд┐рдпрд╛рдБ","рдЧрд▓рд┐рдпрд╛рдВ"] },
  { word: "рд░реЛрдЯреА", answers:["рд░реЛрдЯрд┐рдпрд╛рдБ","рд░реЛрдЯрд┐рдпрд╛рдВ"] },
  { word: "рдЧрд╛рдбрд╝реА", answers:["рдЧрд╛рдбрд╝рд┐рдпрд╛рдБ","рдЧрд╛рдбрд╝рд┐рдпреЛрдВ","рдЧрд╛рдбрд┐рдпрд╛рдБ"] },
  { word: "рдХрд┐рддрд╛рдм", answers:["рдХрд┐рддрд╛рдмреЗрдВ","рдХрд┐рддрд╛рдмреЗ"] }
];

const lingQuestions = [
  { male: "рд░рд╛рдЬрд╛", female: "рд░рд╛рдиреА" },
  { male: "рд╢реЗрд░", female: "рд╢реЗрд░рдиреА" },
  { male: "рд▓рдбрд╝рдХрд╛", female: "рд▓рдбрд╝рдХреА" },
  { male: "рдкрд┐рддрд╛", female: "рдорд╛рддрд╛" },
  { male: "рдХреБрддреНрддрд╛", female: "рдХреБрддрд┐рдпрд╛" },
  { male: "рдШреЛрдбрд╝рд╛", female: "рдШреЛрдбрд╝реА" },
  { male: "рдмрдХрд░рд╛", female: "рдмрдХрд░реА" },
  { male: "рд╣рд╛рдереА", female: "рд╣рд╛рдерд┐рдиреА" },
  { male: "рдкреБрддреНрд░", female: "рдкреБрддреНрд░реА" },
  { male: "рдЕрдзреНрдпрд╛рдкрдХ", female: "рдЕрдзреНрдпрд╛рдкрд┐рдХрд╛" },
  { male: "рд╕реЗрда", female: "рд╕реЗрдард╛рдиреА" },
  { male: "рдирд╛рдирд╛", female: "рдирд╛рдиреА" },
  { male: "рдореБрд░реНрдЧрд╛", female: "рдореБрд░реНрдЧреА" },
  { male: "рдкрддрд┐", female: "рдкрддреНрдиреА" },
  { male: "рд╢реЗрд░рдиреА", female: "рд╢реЗрд░" } // reversed to allow female->male
];

/* ---------------- Build Pool ---------------- */
let pool = [];
vachanQuestions.forEach(q=>pool.push(Object.assign({type:'vachan'}, q)));
lingQuestions.forEach(q=>pool.push(Object.assign({type:'ling'}, q)));

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
shuffle(pool);

/* ---------------- State ---------------- */
let idx=0, score=0, correctCount=0, wrongCount=0, started=false, startTime=0;
const maxQ = pool.length;

/* ---------------- Elements ---------------- */
const loginModal = document.getElementById('loginModal');
const loginName = document.getElementById('loginName');
const loginBtn = document.getElementById('loginBtn');
const loginMsg = document.getElementById('loginMsg');
const quizArea = document.getElementById('quizArea');
const questionEl = document.getElementById('question');
const translationEl = document.getElementById('translation');
const answerInput = document.getElementById('answerInput');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const speakBtn = document.getElementById('speakBtn');
const passBtn = document.getElementById('passBtn');
const replayBtn = document.getElementById('replayBtn');
const checkBtn = document.getElementById('checkBtn');
const feedbackEl = document.getElementById('feedback');
const scoreEl = document.getElementById('score');
const logoutBtn = document.getElementById('logoutBtn');
const voiceWarn = document.getElementById('voiceWarn');

/* ---------------- Voice ---------------- */
let chosenVoice = null;
function pickVoice(){
  const voices = speechSynthesis.getVoices();
  if(!voices.length) return null;
  const hi = voices.filter(v => (v.lang||'').toLowerCase().startsWith('hi'));
  return hi.find(v=>/fema|aditi|shruti|google/i.test(v.name)) || hi[0] || voices[0];
}
speechSynthesis.onvoiceschanged = ()=>{ chosenVoice = pickVoice(); };
chosenVoice = pickVoice();

function speak(text, cb){
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'hi-IN';
    u.rate = 0.95;
    if(chosenVoice) u.voice = chosenVoice;
    if(cb) u.onend = cb;
    speechSynthesis.speak(u);
  }catch(e){ console.warn(e); }
}

/* ---------------- Normalize & Match ---------------- */
function normalize(s){ if(!s) return ''; return s.toString().normalize('NFD').replace(/[\u093C-\u094D\u0964-\u0965\s\p{P}]/gu,'').toLowerCase(); }
function levenshtein(a,b){a=normalize(a);b=normalize(b); if(a===b) return 0; const al=a.length, bl=b.length; const dp=Array.from({length:al+1}, ()=>Array(bl+1).fill(0)); for(let i=0;i<=al;i++) dp[i][0]=i; for(let j=0;j<=bl;j++) dp[0][j]=j; for(let i=1;i<=al;i++) for(let j=1;j<=bl;j++) dp[i][j]=(a[i-1]===b[j-1])?dp[i-1][j-1]:Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+1); return dp[al][bl]; }
function matchAnswer(inp, expected){ inp=normalize(inp); expected=normalize(expected); if(!inp||!expected) return false; if(inp===expected) return true; const d=levenshtein(inp,expected); const len=Math.max(inp.length,expected.length); return d<=Math.max(1,Math.floor(len*0.25)); }

/* ---------------- Show Question ---------------- */
function showQuestion(){
  if(idx >= pool.length){ endQuiz(); return; }
  const q = pool[idx];
  if(q.type==='vachan'){
    questionEl.textContent = `рд╡рдЪрди рдмрджрд▓рд┐рдП: ${q.word} рдХрд╛ рдмрд╣реБрд╡рдЪрди рдмрддрд╛рдЗрдП`;
    translationEl.textContent = `(Change to plural)`;
    q._expected = q.answers || [];
  } else {
    if(Math.random()<0.5){
      questionEl.textContent = `рд▓рд┐рдВрдЧ рдмрджрд▓рд┐рдП: ${q.male} рдХрд╛ рд╕реНрддреНрд░реАрд▓рд┐рдВрдЧ рдмрддрд╛рдЗрдП`;
      translationEl.textContent='(Change to feminine)';
      q._expected = [q.female];
    } else {
      questionEl.textContent = `рд▓рд┐рдВрдЧ рдмрджрд▓рд┐рдП: ${q.female} рдХрд╛ рдкреБрд▓реНрд▓рд┐рдВрдЧ рдмрддрд╛рдЗрдП`;
      translationEl.textContent='(Change to masculine)';
      q._expected = [q.male];
    }
  }
  answerInput.value=''; feedbackEl.textContent=''; answerInput.disabled=false; passBtn.disabled=false; replayBtn.disabled=false;
  speak(questionEl.textContent);
}

/* ---------------- Start / Reset ---------------- */
startBtn.onclick = ()=>{
  if(!started){ started=true; idx=0; score=0; correctCount=0; wrongCount=0; startTime=Date.now(); shuffle(pool); showQuestion(); scoreEl.textContent=''; return; }
  idx=0; score=0; correctCount=0; wrongCount=0; startTime=Date.now(); shuffle(pool); showQuestion(); scoreEl.textContent='';
};
resetBtn.onclick = ()=>{ started=false; idx=0; score=0; correctCount=0; wrongCount=0; questionEl.textContent='рдХреНрд╡рд┐рдЬрд╝ рд░реАрд╕реЗрдЯ рд╣реБрдЖред "рд╢реБрд░реВ рдХрд░реЗрдВ" рджрдмрд╛рдПрдБ'; scoreEl.textContent=''; feedbackEl.textContent=''; };

/* ---------------- Check Answer ---------------- */
function checkAnswerInput(userTxt){
  const q = pool[idx]; const list=q._expected||[]; 
  if(list.some(e=>matchAnswer(userTxt,e))){
    correctCount++; score++; feedbackEl.className='correct'; feedbackEl.textContent='рд╕рд╣реА рдЙрддреНрддрд░ тЬУ';
    speak('рд╕рд╣реА рдЙрддреНрддрд░', ()=>{ idx++; showQuestion(); });
  } else {
    wrongCount++; feedbackEl.className='wrong'; feedbackEl.textContent='рдЧрд▓рдд рдЙрддреНрддрд░ тАФ рдлрд┐рд░ рд╕реЗ рдмреЛрд▓реЗрдВ рдпрд╛ рдкрд╛рд╕ рджрдмрд╛рдПрдБред';
    speak('рдЧрд▓рдд рдЙрддреНрддрд░');
  }
}
checkBtn.onclick=()=>{ const v=answerInput.value.trim(); if(!v){ feedbackEl.className='wrong'; feedbackEl.textContent='рдХреГрдкрдпрд╛ рдЙрддреНрддрд░ рджреЗрдВ'; return; } checkAnswerInput(v); };
answerInput.addEventListener('keydown', e=>{ if(e.key==='Enter') checkBtn.click(); });

/* ---------------- Pass & Replay ---------------- */
passBtn.onclick=()=>{ idx++; showQuestion(); };
replayBtn.onclick=()=>{ if(questionEl.textContent) speak(questionEl.textContent); };

/* ---------------- Speech Recognition ---------------- */
let recognition=null;
try{
  const R=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(R){
    recognition=new R();
    recognition.lang='hi-IN';
    recognition.interimResults=false;
    recognition.maxAlternatives=1;
    recognition.onresult=e=>{
      const text=e.results[0][0].transcript.trim();
      answerInput.value=text;
      setTimeout(()=>checkAnswerInput(text),300);
    };
    recognition.onerror=ev=>{ feedbackEl.className='wrong'; feedbackEl.textContent='ЁЯОЩ рддреНрд░реБрдЯрд┐: '+(ev.error||'error'); };
    recognition.onend=()=>{ speakBtn.textContent='ЁЯОд рдмреЛрд▓реЗрдВ'; };
    speakBtn.onclick=()=>{ try{ recognition.start(); speakBtn.textContent='тП╣ рд░реЛрдХреЗрдВ'; feedbackEl.textContent='рд╕реБрди рд░рд╣рд╛ рд╣реВрдБ...'; }catch(e){console.warn(e);} };
  } else { speakBtn.disabled=true; voiceWarn.style.display='block'; }
}catch(e){ console.warn(e); speakBtn.disabled=true; voiceWarn.style.display='block'; }

/* ---------------- End Quiz ---------------- */
function endQuiz(){
  started=false; questionEl.textContent='рдХреНрд╡рд┐рдЬрд╝ рд╕рдорд╛рдкреНрдд!'; translationEl.textContent=''; feedbackEl.textContent='';
  const total=pool.length;
  scoreEl.textContent=`рдЖрдкрдХрд╛ рд╕реНрдХреЛрд░: ${score} / ${total} рд╕рд╣реА: ${correctCount} рдЧрд▓рдд: ${wrongCount}`;
  speak(`рдХреНрд╡рд┐рдЬ рд╕рдорд╛рдкреНрддред рдЖрдкрдХрд╛ рд╕реНрдХреЛрд░ ${score} рдореЗрдВ рд╕реЗ ${total} рд╣реИред`);
}

/* ---------------- Logout & Report ---------------- */
logoutBtn.onclick=async()=>{
  const name=localStorage.getItem('quiz_user_name')||loginName.value||'Unknown';
  const total=pool.length||0;
  const durationSec=Math.round((Date.now()-(startTime||Date.now()))/1000);
  const payload={ action:"logout", name, score, attempted:idx, remarks:"", duration:`${durationSec} sec` };
  
  // Apps Script
  let sentOK=false;
  try{
    const res=await fetch(APPS_SCRIPT_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    if(res.ok){ const txt=await res.text(); console.log('Apps Script:',txt); sentOK=true; }
  }catch(err){ console.warn(err); }

  // WhatsApp
  const waMsg=encodeURIComponent(`рдирдорд╕реНрддреЗ! рдореИрдВ ${name} рд╣реВрдБред рдореЗрд░рд╛ рд╕реНрдХреЛрд░ ${score}/${total} рд╣реИред`);
  window.open(`https://wa.me/${WHATSAPP_PHONE}?text=${waMsg}`,'_blank');

  // Mark local
  if(name) localStorage.setItem('quiz_done_for_'+name, JSON.stringify({score,total,time:new Date().toLocaleString()}));
  localStorage.removeItem('quiz_user_name');

  if(!sentOK) alert('рд░рд┐рдкреЛрд░реНрдЯ рднреЗрдЬрдиреЗ рдореЗрдВ рд╕рдорд╕реНрдпрд╛ (Apps Script)ред WhatsApp рдбреНрд░рд╛рдлреНрдЯ рдЦреБрд▓ рдЧрдпрд╛ред'); else alert('рд░рд┐рдкреЛрд░реНрдЯ рд╕рдлрд▓ред WhatsApp рдбреНрд░рд╛рдлреНрдЯ рднреА рдЦреБрд▓ рдЧрдпрд╛ред');
  setTimeout(()=>location.reload(),600);
};

/* ---------------- Login ---------------- */
loginBtn.onclick = ()=>{
  const name = loginName.value.trim();
  if(!name){ loginMsg.textContent = "рдХреГрдкрдпрд╛ рдирд╛рдо рджрд░реНрдЬ рдХрд░реЗрдВ"; return; }
  if(localStorage.getItem('quiz_done_for_'+name)){ loginMsg.textContent = "рдЖрдкрдиреЗ рдкрд╣рд▓реЗ рд╣реА рдЗрд╕ рдХреНрд╡рд┐рдЬрд╝ рдХреЛ рдкреВрд░рд╛ рдХрд░ рд▓рд┐рдпрд╛ рд╣реИред"; return; }
  localStorage.setItem('quiz_user_name', name);
  loginModal.style.display = 'none';
  quizArea.style.display = 'block';

  // Start quiz immediately after login
  started = true;
  idx = 0;
  score = 0;
  correctCount = 0;
  wrongCount = 0;
  startTime = Date.now();
  shuffle(pool);
  showQuestion();
  scoreEl.textContent = '';
};
