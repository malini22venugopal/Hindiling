<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‚Äî ‡§≤‡§ø‡§Ç‡§ó & ‡§µ‡§ö‡§® (With Email Report)</title>
<style>
  body{font-family:'Noto Sans Devanagari',system-ui,Arial,sans-serif;background:#fff;margin:0;padding:20px;text-align:center;color:#111}
  h1{color:#b71c1c;margin:6px 0 12px}
  .box{max-width:720px;margin:8px auto;padding:12px}
  input{padding:10px;font-size:16px;width:90%;max-width:420px;border:1px solid #ccc;border-radius:6px;text-align:center}
  button{padding:10px 14px;border-radius:8px;border:none;background:#1565c0;color:#fff;font-size:15px;cursor:pointer;margin:6px}
  button.secondary{background:#6c757d}
  #question{font-size:1.25rem;margin:18px 0;min-height:56px}
  #feedback{margin-top:12px;font-weight:700;min-height:28px}
  #score{margin-top:12px;color:#0b6623;font-weight:700}
  #logoutBtn{background:#b71c1c}
</style>
</head>
<body>
  <h1>‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‚Äî ‡§≤‡§ø‡§Ç‡§ó & ‡§µ‡§ö‡§®</h1>

  <!-- LOGIN -->
  <div id="loginBox" class="box">
    <h3>‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç</h3>
    <input id="loginName" placeholder="‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç"/><br>
    <button id="loginStart">‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠ ‡§ï‡§∞‡•á‡§Ç</button>
    <p id="loginMsg" style="color:red"></p>
  </div>

  <!-- QUIZ -->
  <div id="quizBox" class="box" style="display:none">
    <div id="question">‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è "‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç" ‡§¶‡§¨‡§æ‡§è‡§Å</div>
    <input id="answer" placeholder="‡§â‡§§‡•ç‡§§‡§∞ ‡§¨‡•ã‡§≤‡§ø‡§è ‡§Ø‡§æ ‡§≤‡§ø‡§ñ‡§ø‡§è (Enter ‡§∏‡•á ‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç)" disabled>
    <div>
      <button id="startBtn">‚ñ∂Ô∏è ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç</button>
      <button id="micBtn" disabled>üé§ ‡§¨‡•ã‡§≤‡•á‡§Ç</button>
      <button id="passBtn" class="secondary" disabled>‚è≠ ‡§™‡§æ‡§∏</button>
      <button id="replayBtn" class="secondary" disabled>üîÅ ‡§´‡§ø‡§∞ ‡§∏‡•Å‡§®‡•á‡§Ç</button>
      <button id="checkBtn">‚úÖ ‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç</button>
    </div>
    <div id="feedback"></div>
    <div id="score"></div>
    <div style="margin-top:14px">
      <button id="logoutBtn">üîí ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§î‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≠‡•á‡§ú‡•á‡§Ç</button>
    </div>
  </div>

<script>
/* --------------------------
  Questions (30 mix is assumed; adjust as needed)
  For brevity a smaller set used here ‚Äî replace with your full list if needed.
---------------------------*/
const vachanQuestions = [
  { word: "‡§ï‡§ø‡§§‡§æ‡§¨", answers:["‡§ï‡§ø‡§§‡§æ‡§¨‡•á‡§Ç","‡§ï‡§ø‡§§‡§æ‡§¨‡•á"] },
  { word: "‡§≤‡§°‡§º‡§ï‡§æ", answers:["‡§≤‡§°‡§º‡§ï‡•á","‡§≤‡§°‡§º‡§ï‡•á‡§Ç"] },
  { word: "‡§≤‡§°‡§º‡§ï‡•Ä", answers:["‡§≤‡§°‡§º‡§ï‡§ø‡§Ø‡§æ‡§Å","‡§≤‡§°‡§º‡§ï‡§ø‡§Ø‡§æ‡§Ç"] },
  { word: "‡§´‡•Ç‡§≤", answers:["‡§´‡•Ç‡§≤"] },
  { word: "‡§∏‡•á‡§¨", answers:["‡§∏‡•á‡§¨"] }
];
const lingPairs = [
  ["‡§∞‡§æ‡§ú‡§æ","‡§∞‡§æ‡§®‡•Ä"],
  ["‡§∂‡•á‡§∞","‡§∂‡•á‡§∞‡§®‡•Ä"],
  ["‡§™‡§§‡§ø","‡§™‡§§‡•ç‡§®‡•Ä"],
  ["‡§Æ‡•Å‡§∞‡•ç‡§ó‡§æ","‡§Æ‡•Å‡§∞‡•ç‡§ó‡•Ä"],
  ["‡§™‡•Å‡§§‡•ç‡§∞","‡§™‡•Å‡§§‡•ç‡§∞‡•Ä"]
];
function buildLingQs(){
  const out=[];
  lingPairs.forEach(([m,f])=>{
    if(Math.random()<0.5) out.push({type:'ling',word:m,ask:'‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä‡§≤‡§ø‡§Ç‡§ó',answers:[f]});
    else out.push({type:'ling',word:f,ask:'‡§™‡•Å‡§≤‡•ç‡§≤‡§ø‡§Ç‡§ó',answers:[m]});
  });
  return out;
}
function buildPool(){
  const pool=[];
  vachanQuestions.forEach(q=>pool.push({type:'vachan',...q}));
  buildLingQs().forEach(q=>pool.push(q));
  shuffle(pool);
  return pool;
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* UI elements */
const loginBox = document.getElementById('loginBox');
const quizBox = document.getElementById('quizBox');
const loginName = document.getElementById('loginName');
const loginStart = document.getElementById('loginStart');
const loginMsg = document.getElementById('loginMsg');

const questionDiv = document.getElementById('question');
const answerInput = document.getElementById('answer');
const startBtn = document.getElementById('startBtn');
const micBtn = document.getElementById('micBtn');
const passBtn = document.getElementById('passBtn');
const replayBtn = document.getElementById('replayBtn');
const checkBtn = document.getElementById('checkBtn');
const feedbackDiv = document.getElementById('feedback');
const scoreDiv = document.getElementById('score');
const logoutBtn = document.getElementById('logoutBtn');

let pool = [], idx=0, score=0;
let recognition = null, listening=false, chosenVoice=null;

/* Normalize/match helpers (same tolerant rules) */
function normalizeHindi(s){
  if(!s) return '';
  s = s.toString().normalize('NFD');
  s = s.replace(/[‡§Å‡§Ç]/g,'‡§Ç').replace(/[‡•â‡•ã‡•å]/g,'‡•ã').replace(/[‡•à‡•á]/g,'‡•á')
       .replace(/[‡•É]/g,'‡§∞').replace(/[‡•Ä‡§ø]/g,'‡§ø').replace(/[‡•Ç‡•Å]/g,'‡•Å')
       .replace(/[^\u0900-\u097F]/g,'').replace(/‡•ç+/g,'');
  return s;
}
function lcsLen(a,b){
  const n=a.length,m=b.length;
  if(n===0||m===0) return 0;
  const dp=Array.from({length:n+1},()=>Array(m+1).fill(0));
  for(let i=1;i<=n;i++) for(let j=1;j<=m;j++) dp[i][j] = (a[i-1]===b[j-1])? dp[i-1][j-1]+1 : Math.max(dp[i-1][j],dp[i][j-1]);
  return dp[n][m];
}
function isGoodMatch(user, expected){
  const u=normalizeHindi(user), e=normalizeHindi(expected);
  if(!u||!e) return false;
  if(e==='‡§∏‡•á‡§¨') return u==='‡§∏‡•á‡§¨';
  if(u===e) return true;
  const sim = lcsLen(u,e)/Math.max(u.length,e.length);
  return sim>=0.7 && u.length >= Math.max(1, e.length-1);
}

/* Voice helpers */
function pickFemaleHindiVoice(){
  const voices = speechSynthesis.getVoices();
  if(!voices || voices.length===0) return null;
  const hi = voices.filter(v => (v.lang||'').toLowerCase().startsWith('hi'));
  const hints=['female','aditi','shruti','google','aarya','ananya'];
  return hi.find(v=>hints.some(h=> (v.name||'').toLowerCase().includes(h))) || hi[0] || voices[0];
}
function speak(text, onend){
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang='hi-IN'; u.rate=0.95;
    if(!chosenVoice) chosenVoice = pickFemaleHindiVoice();
    if(chosenVoice) u.voice = chosenVoice;
    if(onend) u.onend = onend;
    speechSynthesis.speak(u);
  }catch(e){ console.warn(e); }
}

/* Build pool on login */
function initQuiz(){
  pool = buildPool();
  idx = 0; score = 0;
  scoreDiv.textContent = '';
  feedbackDiv.textContent = '';
}

/* Show current question and speak */
function showQ(){
  if(idx >= pool.length){ finishQuiz(); return; }
  const q = pool[idx];
  const prompt = (q.type==='vachan')? `‡§µ‡§ö‡§® ‡§¨‡§¶‡§≤‡§ø‡§è: ${q.word} ‡§ï‡§æ ‡§¨‡§π‡•Å‡§µ‡§ö‡§® ‡§¨‡§§‡§æ‡§á‡§è` : `‡§≤‡§ø‡§Ç‡§ó ‡§¨‡§¶‡§≤‡§ø‡§è: ${q.word} ‡§ï‡§æ ${q.ask} ‡§¨‡§§‡§æ‡§á‡§è`;
  questionDiv.textContent = prompt;
  answerInput.value = '';
  feedbackDiv.textContent = '';
  answerInput.disabled=false; passBtn.disabled=false; replayBtn.disabled=false;
  speak(prompt);
}

/* check answer */
function handleAnswer(userInput){
  const q = pool[idx];
  const expectedList = q.answers || q._expected || [];
  if(expectedList.some(e=>isGoodMatch(userInput,e))){
    score++; feedbackDiv.style.color='#1a7f3a'; feedbackDiv.textContent='‚úÖ ‡§¨‡§π‡•Å‡§§ ‡§¨‡§¢‡§º‡§ø‡§Ø‡§æ, ‡§∏‡§π‡•Ä ‡§ú‡§µ‡§æ‡§¨!';
    speak('‡§¨‡§π‡•Å‡§§ ‡§¨‡§¢‡§º‡§ø‡§Ø‡§æ, ‡§∏‡§π‡•Ä ‡§ú‡§µ‡§æ‡§¨!', ()=> setTimeout(()=>{ idx++; showQ(); }, 2000)); // 2s delay
  } else {
    feedbackDiv.style.color='#c00'; feedbackDiv.textContent='‚ùå ‡§´‡§ø‡§∞ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç!';
    speak('‡§´‡§ø‡§∞ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç!');
  }
}

/* UI button handlers */
startBtn.onclick = ()=>{ initQuiz(); showQ(); };
checkBtn.onclick = ()=>{ const v=answerInput.value.trim(); if(!v) { feedbackDiv.textContent='‡§ï‡•É‡§™‡§Ø‡§æ ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§Ç'; return; } handleAnswer(v); };
passBtn.onclick = ()=>{ idx++; showQ(); };
replayBtn.onclick = ()=>{ if(questionDiv.textContent) speak(questionDiv.textContent); };

/* Speech recognition */
try{
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(Rec){
    recognition = new Rec();
    recognition.lang = 'hi-IN';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.onresult = e => {
      setTimeout(()=>{ // stabilization for short words
        const said = e.results[0][0].transcript.trim();
        answerInput.value = said;
        handleAnswer(said);
      }, 1000);
    };
    recognition.onerror = ev => { feedbackDiv.textContent = 'üéôÔ∏è ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + (ev.error||'error'); listening=false; micBtn.textContent='üé§ ‡§¨‡•ã‡§≤‡•á‡§Ç'; };
    recognition.onend = ()=> { listening=false; micBtn.textContent='üé§ ‡§¨‡•ã‡§≤‡•á‡§Ç'; };
    micBtn.onclick = ()=>{
      if(listening){ try{ recognition.stop(); }catch(e){} listening=false; micBtn.textContent='üé§ ‡§¨‡•ã‡§≤‡•á‡§Ç'; }
      else { recognition.start(); listening=true; micBtn.textContent='‚èπ ‡§∞‡•ã‡§ï‡•á‡§Ç'; feedbackDiv.textContent=''; }
    };
  } else {
    micBtn.disabled = true; micBtn.textContent='‡§Æ‡§æ‡§á‡§ï ‡§®‡§π‡•Ä‡§Ç';
  }
}catch(e){ console.warn(e); micBtn.disabled=true; micBtn.textContent='‡§Æ‡§æ‡§á‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø'; }

/* Finish quiz */
function finishQuiz(){
  questionDiv.textContent = '‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§!';
  feedbackDiv.textContent = '';
  scoreDiv.textContent = `‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§ï‡•ã‡§∞: ${score} / ${pool.length}`;
  speak(`${score} ‡§Æ‡•á‡§Ç ‡§∏‡•á ${pool.length}`); // speak only score
  // show logout button (already visible)
}

/* ===== LOGIN flow ===== */
loginStart.onclick = ()=>{
  const name = (loginName.value || '').trim();
  if(!name){ loginMsg.textContent = '‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç'; return; }
  // check one-time per browser
  if(localStorage.getItem('quiz_done_for_'+name)){ loginMsg.textContent = '‡§Ü‡§™‡§®‡•á ‡§™‡§π‡§≤‡•á ‡§π‡•Ä ‡§≤‡§ø‡§Ø‡§æ ‡§π‡•à‡•§'; return; }
  // set session
  localStorage.setItem('quiz_user_name', name);
  loginBox.style.display = 'none';
  quizBox.style.display = 'block';
  chosenVoice = pickFemaleHindiVoice();
  speechSynthesis.onvoiceschanged = ()=> { chosenVoice = pickFemaleHindiVoice(); };
};

/* ===== LOGOUT: send report to Apps Script (email) and clear login ===== */
logoutBtn.onclick = async ()=>{
  const name = localStorage.getItem('quiz_user_name') || 'Unknown';
  const total = pool.length || 0;
  const payload = {
    name: name,
    score: score,
    total: total,
    date: new Date().toLocaleDateString(),
    time: new Date().toLocaleTimeString()
  };

  // --- 1) send to Apps Script (email) ---
  const SCRIPT_URL = "YOUR_SCRIPT_URL_HERE"; // <<--- REPLACE with your deployed Apps Script web app URL
  try{
    const resp = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    // ignore response details; proceed
  }catch(err){
    console.warn('Report send failed', err);
    // we continue ‚Äî WhatsApp step below still works
  }

  // --- 2) open WhatsApp draft to your number ---
  const myPhone = "919994895676"; // <<--- YOUR number (use full country code)
  const waMsg = encodeURIComponent(`‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ${name} ‡§π‡•Ç‡§Å‡•§ ‡§Æ‡•á‡§∞‡§æ ‡§∏‡•ç‡§ï‡•ã‡§∞ ${score}/${total} ‡§π‡•à‡•§`);
  window.open(`https://wa.me/${myPhone}?text=${waMsg}`, '_blank');

  // Mark as done so they cannot take quiz again on same browser
  localStorage.setItem('quiz_done_for_'+name, JSON.stringify(payload));
  // Clear session user
  localStorage.removeItem('quiz_user_name');

  // Optionally redirect to login or show a message
  setTimeout(()=>{ alert('‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≠‡•á‡§ú‡•Ä ‡§ó‡§Ø‡•Ä / ‡§≠‡•á‡§ú‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡•Ä ‡§ó‡§Ø‡•Ä‡•§ ‡§Ö‡§¨ ‡§Ü‡§™ ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§π‡•ã ‡§ó‡§è ‡§π‡•à‡§Ç‡•§'); location.reload(); }, 800);
};

</script>
</body>
</html>
