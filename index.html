<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>рд╣рд┐рдВрджреА рдСрдбрд┐рдпреЛ рдХреНрд╡рд┐рдЬрд╝ тАФ рд▓рд┐рдВрдЧ & рд╡рдЪрди</title>
<style>
  body{font-family:'Noto Sans Devanagari',sans-serif;background:#fffdf9;margin:0;padding:20px;text-align:center}
  h1{color:#b71c1c;margin-bottom:6px}
  .controls{margin:10px 0}
  button{margin:6px;padding:10px 14px;border:none;border-radius:8px;background:#1565c0;color:#fff;font-size:15px;cursor:pointer}
  button.secondary{background:#6c757d}
  #questionText{font-size:1.4rem;margin:18px 0;min-height:48px}
  input{padding:10px;font-size:16px;width:80%;max-width:360px;border:1px solid #cfd8e3;border-radius:8px;text-align:center}
  #feedbackText{margin-top:10px;font-size:18px;font-weight:700;min-height:26px}
  #score{margin-top:12px;font-size:16px;color:#0b6623}
  .small{font-size:13px;color:#555;margin-top:6px}
</style>
</head>
<body>
  <h1>ЁЯОз рд╣рд┐рдВрджреА рдСрдбрд┐рдпреЛ рдХреНрд╡рд┐рдЬрд╝ тАФ рд▓рд┐рдВрдЧ & рд╡рдЪрди (30 рдкреНрд░рд╢реНрди)</h1>
  <div id="questionText">рдХреНрд╡рд┐рдЬрд╝ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдиреАрдЪреЗ "рд╢реБрд░реВ рдХрд░реЗрдВ" рджрдмрд╛рдПрдБ</div>

  <div>
    <input id="answerInput" placeholder="рдЙрддреНрддрд░ рдмреЛрд▓реЗрдВ рдпрд╛ рд▓рд┐рдЦреЗрдВ (Enter рд╕реЗ рд╕рдмрдорд┐рдЯ)" disabled />
  </div>

  <div class="controls">
    <button id="startBtn">тЦ╢я╕П рд╢реБрд░реВ рдХрд░реЗрдВ</button>
    <button id="resetBtn" class="secondary">ЁЯФБ рд░реАрд╕реЗрдЯ</button>
    <button id="micBtn" disabled>ЁЯОд рдмреЛрд▓реЗрдВ</button>
    <button id="passBtn" class="secondary" disabled>тПн рдкрд╛рд╕</button>
    <button id="replayBtn" class="secondary" disabled>ЁЯФБ рдлрд┐рд░ рд╕реБрдиреЗрдВ</button>
  </div>

  <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap">
    <button id="submitBtn" class="">тЬЕ рдЬрд╛рдБрдЪреЗрдВ</button>
  </div>

  <div id="feedbackText"></div>
  <div id="score"></div>
  <div class="small">рдЯрд┐рдк: рдореЛрдмрд╛рдЗрд▓/рд▓реИрдкрдЯреЙрдк рдкрд░ Chrome рдореЗрдВ рдмреЗрд╣рддрд░ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред рдкрд╣рд▓реА рдмрд╛рд░ рдорд╛рдЗрдХреНрд░реЛрдлрд╝реЛрди рдЕрдиреБрдорддрд┐ рджреЗрдВред</div>

<script>
/* ============================
   Questions (15 рд▓рд┐рдВрдЧ + 15 рд╡рдЪрди)
   No duplicates; will be shuffled on start/reset
   ============================ */
const vachanQuestions = [
  { word:"рдЧрд╛рдп", answers:["рдЧрд╛рдпреЗрдВ","рдЧрд╛рдП","рдЧрд╛рдпреЗрдВред"] },
  { word:"рдорд╛рд▓рд╛", answers:["рдорд╛рд▓рд╛рдПрдБ","рдорд╛рд▓рд╛рдпреЗрдВ","рдорд╛рд▓рд╛рдПрдВ"] },
  { word:"рдЪрд┐рдбрд╝рд┐рдпрд╛", answers:["рдЪрд┐рдбрд╝рд┐рдпрд╛рдПрдБ","рдЪрд┐рдбрд╝рд┐рдпрд╛рдпреЗрдВ","рдЪрд┐рдбрд╝рд┐рдпрд╛рдПрдВ"] },
  { word:"рд▓рдбрд╝рдХреА", answers:["рд▓рдбрд╝рдХрд┐рдпрд╛рдБ","рд▓рдбрд╝рдХрд┐рдпреЙрдВ","рд▓рдбрд╝рдХрд┐рдпрд╛рдВ"] },
  { word:"рдирджреА", answers:["рдирджрд┐рдпрд╛рдБ","рдирджрд┐рдпреЙрдВ","рдирджрд┐рдпрд╛рдВ"] },
  { word:"рд░реЛрдЯреА", answers:["рд░реЛрдЯрд┐рдпрд╛рдБ","рд░реЛрдЯрд┐рдпреЙрдВ","рд░реЛрдЯрд┐рдпрд╛рдВ"] },
  { word:"рдЧрд╛рдбрд╝реА", answers:["рдЧрд╛рдбрд╝рд┐рдпрд╛рдБ","рдЧрд╛рдбрд╝рд┐рдпреЛрдВ","рдЧрд╛рдбрд┐рдпрд╛рдВ"] },
  { word:"рдХреБрд░реНрд╕реА", answers:["рдХреБрд░реНрд╕рд┐рдпрд╛рдБ","рдХреБрд░реНрд╕рд┐рдпрд╛рдВ","рдХреБрд░реНрд╕рд┐рдпреЛрдВ"] },
  { word:"рдХрд┐рддрд╛рдм", answers:["рдХрд┐рддрд╛рдмреЗрдВ","рдХрд┐рддрд╛рдмреЛрдВ","рдХрд┐рддрд╛рдмреЗ"] },
  { word:"рд▓рдбрд╝рдХрд╛", answers:["рд▓рдбрд╝рдХреЗ","рд▓рдбрд╝рдХреЗрдВ"] },
  { word:"рд░реБрдкрдпрд╛", answers:["рд░реБрдкрдпреЗ","рд░реБрдкрдП"] },
  { word:"рдХрдорд░рд╛", answers:["рдХрдорд░реЗ","рдХрдорд░реЛрдВ"] },
  { word:"рддрд╕реНрд╡реАрд░", answers:["рддрд╕реНрд╡реАрд░реЗрдВ","рддрд╕реНрд╡реАрд░реЛрдВ"] },
  { word:"рд╕реЗрдм", answers:["рд╕реЗрдм","рд╕реЗрдмреЛрдВ"] },
  { word:"рдлреВрд▓", answers:["рдлреВрд▓","рдлреВрд▓реЛрдВ"] }
];

const lingPairs = [
  ["рд░рд╛рдЬрд╛","рд░рд╛рдиреА"],
  ["рд╢реЗрд░","рд╢реЗрд░рдиреА"],
  ["рдкрддрд┐","рдкрддреНрдиреА"],
  ["рдирд╛рдирд╛","рдирд╛рдиреА"],
  ["рдореБрд░реНрдЧрд╛","рдореБрд░реНрдЧреА"],
  ["рдкреБрддреНрд░","рдкреБрддреНрд░реА"],
  ["рдЕрдзреНрдпрд╛рдкрдХ","рдЕрдзреНрдпрд╛рдкрд┐рдХрд╛"],
  ["рд╕реЗрда","рд╕реЗрдард╛рдиреА"]
];

/* Build ling questions once: for each pair create two questions (one asking рдкреБрд▓реНрд▓рд┐рдВрдЧ/one asking рд╕реНрддреНрд░реАрд▓рд┐рдВрдЧ).
   But ensure each word appears only once overall by making one question per pair *direction decided randomly*.
   We'll create one question per pair randomly asking either male->female or female->male, to avoid any duplication.
*/
let lingQuestions = [];
lingPairs.forEach(pair=>{
  const [m,f] = pair;
  // randomly choose direction so quiz has mix
  if(Math.random() < 0.5){
    lingQuestions.push({ type:'ling', word:m, ask:'рд╕реНрддреНрд░реАрд▓рд┐рдВрдЧ', answers:[f] });
  } else {
    lingQuestions.push({ type:'ling', word:f, ask:'рдкреБрд▓реНрд▓рд┐рдВрдЧ', answers:[m] });
  }
});

/* Combine questions */
function buildQuestions(){
  const items = [];
  vachanQuestions.forEach(q => items.push({ type:'vachan', word:q.word, answers:q.answers }));
  lingQuestions.forEach(q => items.push(q));
  return items;
}

/* shuffle utility (Fisher-Yates) */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
}

/* ============================
   Voice selection & speak helpers
   ============================ */
let selectedVoice = null;
function chooseFemaleHindiVoice(){
  const voices = speechSynthesis.getVoices();
  if(!voices || voices.length===0) return null;
  const hi = voices.filter(v => (v.lang||'').toLowerCase().startsWith('hi'));
  const femaleHints = ["female","aditi","shruti","samantha","ananya","google","nisha","kajal","leena","aarti"];
  let pick = hi.find(v => femaleHints.some(h => (v.name||'').toLowerCase().includes(h)));
  if(!pick) pick = hi[0] || voices[0];
  return pick;
}
function speak(text, onend){
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "hi-IN";
    u.rate = 0.95;
    if(!selectedVoice) selectedVoice = chooseFemaleHindiVoice();
    if(selectedVoice) u.voice = selectedVoice;
    if(onend) u.onend = onend;
    speechSynthesis.speak(u);
  }catch(e){ console.warn(e); }
}

/* ============================
   Smart Hindi normalization & matching
   - normalize removes punctuation, maps common matra variants,
   - LCS similarity (ordered) used to allow minor differences but
     we also enforce length rule so singular != plural (e.g. рдЧрд╛рдп != рдЧрд╛рдпреЗрдВ)
   ============================ */
function normalizeHindi(s){
  if(!s) return "";
  s = s.toString();
  // Common normalizations (map similar matras to easier forms)
  s = s.normalize('NFD');
  s = s.replace(/[рдБрдВ]/g,'рдВ');                 // nasal unify
  s = s.replace(/реЙ|реМ/g,'реЛ');                 // map o/u variants to рдУ like
  s = s.replace(/реИ|реЗ/g,'реЗ');                 // рдП variants
  s = s.replace(/рд╛/g,'рд╛');
  s = s.replace(/реА|рд┐/g,'рд┐');                 // simplify i-matra
  s = s.replace(/реБ|реВ/g,'реБ');                 // simplify u-matra
  s = s.replace(/[^\u0900-\u097F]+/g,'');    // remove non-Devanagari chars/spaces/punct
  s = s.replace(/реН+/g,'');                   // remove virama to simplify (helps some ASR variants)
  return s;
}

/* Longest Common Subsequence length (ordered) */
function lcsLen(a,b){
  const n=a.length, m=b.length;
  if(n===0 || m===0) return 0;
  const dp = Array.from({length:n+1},()=>Array(m+1).fill(0));
  for(let i=1;i<=n;i++){
    for(let j=1;j<=m;j++){
      if(a[i-1]===b[j-1]) dp[i][j] = dp[i-1][j-1]+1;
      else dp[i][j] = Math.max(dp[i-1][j], dp[i][j-1]);
    }
  }
  return dp[n][m];
}

/* matching policy:
   - userNormalized must equal expectedNormalized OR
   - LCS_similarity >= 0.7 AND userLength >= expectedLength - 1
   This prevents short singulars matching expected plurals (e.g. "рдЧрд╛рдп" won't match "рдЧрд╛рдпреЗрдВ")
*/
function isGoodMatch(user, expected){
  const u = normalizeHindi(user);
  const e = normalizeHindi(expected);
  if(!u || !e) return false;
  if(u === e) return true;
  const lcs = lcsLen(u,e);
  const sim = lcs / Math.max(u.length, e.length); // ratio
  if(sim >= 0.7 && u.length >= Math.max(1, e.length - 1)) return true;
  return false;
}

function matchAnswer(user, validList){
  for(const v of validList){
    if(isGoodMatch(user, v)) return true;
  }
  return false;
}

/* ============================
   UI + quiz state
   ============================ */
const questionText = document.getElementById('questionText');
const answerInput = document.getElementById('answerInput');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const micBtn = document.getElementById('micBtn');
const passBtn = document.getElementById('passBtn');
const replayBtn = document.getElementById('replayBtn');
const submitBtn = document.getElementById('submitBtn');
const feedbackText = document.getElementById('feedbackText');
const scoreDiv = document.getElementById('score');
const statusDiv = document.getElementById('status');

let pool = [], shuffled = [], index = 0, score = 0;
let recognition = null;
let listening = false;

/* prepare pool (call on start/reset) */
function preparePool(){
  // Recreate lingQuestions with random direction per pair to avoid duplication across runs
  lingQuestions = [];
  lingPairsLoop();
  pool = buildQuestions();
  shuffle(pool);
  shuffled = pool;
  index = 0; score = 0;
}

/* lingPairsLoop builds questions array with one direction per pair, chosen randomly */
function lingPairsLoop(){
  // defined as local to rebuild each reset
  const pairs = [
    ["рд░рд╛рдЬрд╛","рд░рд╛рдиреА"],["рд╢реЗрд░","рд╢реЗрд░рдиреА"],["рдкрддрд┐","рдкрддреНрдиреА"],
    ["рдирд╛рдирд╛","рдирд╛рдиреА"],["рдореБрд░реНрдЧрд╛","рдореБрд░реНрдЧреА"],["рдкреБрддреНрд░","рдкреБрддреНрд░реА"],
    ["рдЕрдзреНрдпрд╛рдкрдХ","рдЕрдзреНрдпрд╛рдкрд┐рдХрд╛"],["рд╕реЗрда","рд╕реЗрдард╛рдиреА"]
  ];
  lingQuestions = [];
  pairs.forEach(pair=>{
    const [m,f] = pair;
    if(Math.random() < 0.5) lingQuestions.push({ type:'ling', word:m, ask:'рд╕реНрддреНрд░реАрд▓рд┐рдВрдЧ', answers:[f] });
    else lingQuestions.push({ type:'ling', word:f, ask:'рдкреБрд▓реНрд▓рд┐рдВрдЧ', answers:[m] });
  });
}

/* buildQuestions returns fresh list (vachan + current lingQuestions) */
function buildQuestions(){
  const arr = [];
  vachanQuestions.forEach(q => arr.push({ type:'vachan', word:q.word, answers:q.answers }));
  lingQuestions.forEach(q => arr.push(q));
  return arr;
}

/* Start quiz */
startBtn.onclick = ()=>{
  preparePool();
  answerInput.disabled = false;
  micBtn.disabled = false;
  passBtn.disabled = false;
  replayBtn.disabled = false;
  submitBtn.disabled = false;
  startBtn.disabled = true;
  resetBtn.disabled = false;
  scoreDiv.textContent = '';
  selectedVoice = chooseFemaleHindiVoice();
  speak("рдЪрд▓реЛ, рд╣рдо рд╣рд┐рдВрджреА рдкреНрд░рд╢реНрдиреЛрддреНрддрд░реА рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВред рддреИрдпрд╛рд░ рд╣реЛ рдЬрд╛рдЗрдПред", ()=>setTimeout(()=>showQuestion(), 900));
};

/* Reset (reshuffle and go back to start state) */
resetBtn.onclick = ()=>{
  // stop recognition if running
  if(recognition && listening){ try{ recognition.stop(); }catch(e){} listening=false; micBtn.textContent="ЁЯОд рдмреЛрд▓реЗрдВ"; }
  preparePool();
  answerInput.value = ''; feedbackText.textContent=''; scoreDiv.textContent='';
  startBtn.disabled = false;
  answerInput.disabled = true;
  micBtn.disabled = true;
  passBtn.disabled = true;
  replayBtn.disabled = true;
  submitBtn.disabled = true;
  questionText.textContent = 'рдХреНрд╡рд┐рдЬрд╝ рд░реАрд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ тАФ "рд╢реБрд░реВ рдХрд░реЗрдВ" рджрдмрд╛рдПрдБ';
  speak("рдХреНрд╡рд┐рдЬрд╝ рд░реАрд╕реЗрдЯ рд╣реЛ рдЧрдпрд╛ред рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП 'рд╢реБрд░реВ рдХрд░реЗрдВ' рджрдмрд╛рдПрдБред");
};

/* show current question */
function showQuestion(){
  if(index >= shuffled.length) return finishQuiz();
  const q = shuffled[index];
  let prompt = '';
  if(q.type === 'vachan') prompt = `рд╡рдЪрди рдмрджрд▓рд┐рдП: ${q.word} рдХрд╛ рдмрд╣реБрд╡рдЪрди рдмрддрд╛рдЗрдП`;
  else prompt = `рд▓рд┐рдВрдЧ рдмрджрд▓рд┐рдП: ${q.word} рдХрд╛ ${q.ask} рдмрддрд╛рдЗрдП`;
  questionText.textContent = prompt;
  answerInput.value = '';
  feedbackText.textContent = '';
  // speak question in female tone
  speak(prompt);
}

/* submit (typed) */
submitBtn.onclick = ()=>{
  const user = answerInput.value.trim();
  if(!user){ feedbackText.textContent = "рдХреГрдкрдпрд╛ рдЙрддреНрддрд░ рджреЗрдВ (рдЯрд╛рдЗрдк рдХрд░реЗрдВ рдпрд╛ рдмреЛрд▓реЗрдВ)ред"; return; }
  const expected = shuffled[index].answers;
  if(matchAnswer(user, expected)){
    speak("рдмрд╣реБрдд рдмрдврд╝рд┐рдпрд╛, рд╕рд╣реА рдЬрд╡рд╛рдм!", ()=>{
      feedbackText.style.color = '#1a7f3a';
      feedbackText.textContent = "тЬЕ рдмрд╣реБрдд рдмрдврд╝рд┐рдпрд╛, рд╕рд╣реА рдЬрд╡рд╛рдм!";
      score++; index++;
      setTimeout(()=> showQuestion(), 2500);
    });
  } else {
    feedbackText.style.color = '#c00';
    feedbackText.textContent = "тЭМ рдлрд┐рд░ рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ!";
    speak("рдлрд┐рд░ рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ!");
  }
};

/* pass */
passBtn.onclick = ()=>{
  speak("рдЕрдЧрд▓рд╛ рдкреНрд░рд╢реНрди рд╕реБрдирд┐рдПред", ()=>{
    feedbackText.style.color='#555'; feedbackText.textContent = "тПн рдкреНрд░рд╢реНрди рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЧрдпрд╛ред";
    index++; setTimeout(()=> showQuestion(), 700);
  });
};

/* replay */
replayBtn.onclick = ()=>{ if(questionText.textContent) speak(questionText.textContent); };

/* finish */
function finishQuiz(){
  questionText.textContent = "рдХреНрд╡рд┐рдЬрд╝ рд╕рдорд╛рдкреНрдд!";
  feedbackText.textContent = "";
  scoreDiv.textContent = `рдЖрдкрдХрд╛ рд╕реНрдХреЛрд░: ${score} / ${shuffled.length}`;
  speak(`рдХреНрд╡рд┐рдЬрд╝ рд╕рдорд╛рдкреНрддред рдЖрдкрдХрд╛ рд╕реНрдХреЛрд░ ${score} рдореЗрдВ рд╕реЗ ${shuffled.length} рд╣реИред`);
  // disable controls
  answerInput.disabled = true; micBtn.disabled = true; passBtn.disabled = true; replayBtn.disabled = true; submitBtn.disabled = true;
  startBtn.disabled = false;
}

/* speech recognition (voice input) */
try{
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(Rec){
    recognition = new Rec();
    recognition.lang = "hi-IN";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.onresult = (e)=>{
      listening = false; micBtn.textContent = "ЁЯОд рдмреЛрд▓реЗрдВ";
      const said = e.results[0][0].transcript.trim();
      answerInput.value = said;
      // auto-evaluate like submit
      const expected = shuffled[index].answers;
      if(matchAnswer(said, expected)){
        speak("рдмрд╣реБрдд рдмрдврд╝рд┐рдпрд╛, рд╕рд╣реА рдЬрд╡рд╛рдм!", ()=>{
          feedbackText.style.color = '#1a7f3a';
          feedbackText.textContent = "тЬЕ рдмрд╣реБрдд рдмрдврд╝рд┐рдпрд╛, рд╕рд╣реА рдЬрд╡рд╛рдм!";
          score++; index++;
          setTimeout(()=> showQuestion(), 2500);
        });
      } else {
        feedbackText.style.color = '#c00';
        feedbackText.textContent = "тЭМ рдлрд┐рд░ рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ!";
        speak("рдлрд┐рд░ рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ!");
      }
    };
    recognition.onerror = (ev)=>{ statusDiv.textContent = "ЁЯОЩя╕П рддреНрд░реБрдЯрд┐: " + (ev.error || 'error'); listening=false; micBtn.textContent="ЁЯОд рдмреЛрд▓реЗрдВ"; };
    recognition.onend = ()=>{ listening=false; micBtn.textContent="ЁЯОд рдмреЛрд▓реЗрдВ"; };
    micBtn.onclick = ()=>{
      if(!shuffled.length){ feedbackText.textContent = 'рдХреГрдкрдпрд╛ рдкрд╣рд▓реЗ "рд╢реБрд░реВ рдХрд░реЗрдВ" рджрдмрд╛рдПрдБред'; return; }
      if(listening){ try{ recognition.stop(); }catch(e){} listening=false; micBtn.textContent="ЁЯОд рдмреЛрд▓реЗрдВ"; }
      else { recognition.start(); listening=true; micBtn.textContent="тП╣ рд░реЛрдХреЗрдВ"; statusDiv.textContent = ''; }
    };
  } else {
    micBtn.disabled = true;
    micBtn.textContent = 'рдорд╛рдЗрдХ рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ';
  }
}catch(e){ console.warn(e); micBtn.disabled=true; }

/* allow Enter key on input to submit */
answerInput.addEventListener('keydown', (ev)=>{
  if(ev.key === 'Enter') submitBtn.click();
});

/* initialize (reset state) */
resetBtn.click();

</script>
</body>
</html>
