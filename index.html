<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>рд╣рд┐рдВрджреА рдСрдбрд┐рдпреЛ рдХреНрд╡рд┐рдЬрд╝ тАФ рд▓рд┐рдВрдЧ & рд╡рдЪрди</title>
<style>
  body{font-family:'Noto Sans Devanagari',system-ui,Arial,sans-serif;background:#fff;margin:0;padding:18px;text-align:center;color:#111}
  h1{color:#b71c1c;margin:6px 0 12px}
  .card{max-width:820px;margin:12px auto;padding:14px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);background:#fff}
  input{padding:10px 12px;font-size:16px;width:84%;max-width:420px;border:1px solid #ccc;border-radius:8px;text-align:center}
  button{padding:10px 14px;border-radius:8px;border:none;background:#1565c0;color:#fff;font-size:15px;cursor:pointer;margin:6px}
  button.secondary{background:#6c757d}
  button.warn{background:#b71c1c}
  #question{font-size:1.35rem;margin:18px 0;min-height:56px}
  #feedback{margin-top:12px;font-weight:700;min-height:28px}
  #score{margin-top:12px;color:#0b6623;font-weight:700}
  #voiceWarning{color:#c00;text-align:left;margin-top:8px;display:none;white-space:pre-line}
  .small{font-size:13px;color:#666;margin-top:8px}
</style>
</head>
<body>
  <div class="card">
    <h1>рд╣рд┐рдВрджреА рдСрдбрд┐рдпреЛ рдХреНрд╡рд┐рдЬрд╝ тАФ рд▓рд┐рдВрдЧ & рд╡рдЪрди</h1>

    <!-- LOGIN -->
    <div id="loginArea">
      <p>рдХреГрдкрдпрд╛ рдЕрдкрдирд╛ рдирд╛рдо рджрд░реНрдЬ рдХрд░реЗрдВ (рдПрдХ рдмрд╛рд░):</p>
      <input id="userName" placeholder="рдирд╛рдо рд▓рд┐рдЦреЗрдВ"/><br>
      <div style="margin-top:10px">
        <button id="loginBtn">рдкреНрд░рд╡реЗрд╢ рдХрд░реЗрдВ</button>
      </div>
      <p id="loginMsg" style="color:#c00;margin-top:8px"></p>
    </div>

    <!-- QUIZ -->
    <div id="quizArea" style="display:none">
      <div id="voiceWarning"></div>

      <div id="question">рдХреНрд╡рд┐рдЬрд╝ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП "рд╢реБрд░реВ рдХрд░реЗрдВ" рджрдмрд╛рдПрдБ</div>

      <input id="answer" placeholder="рдЙрддреНрддрд░ рдмреЛрд▓рд┐рдП рдпрд╛ рд▓рд┐рдЦрд┐рдП (Enter рд╕реЗ рдЬрд╛рдБрдЪреЗрдВ)" disabled>

      <div style="margin-top:12px">
        <button id="startBtn">тЦ╢я╕П рд╢реБрд░реВ рдХрд░реЗрдВ</button>
        <button id="micBtn" disabled>ЁЯОд рдмреЛрд▓реЗрдВ</button>
        <button id="passBtn" class="secondary" disabled>тПн рдкрд╛рд╕</button>
        <button id="replayBtn" class="secondary" disabled>ЁЯФБ рдлрд┐рд░ рд╕реБрдиреЗрдВ</button>
        <button id="checkBtn">тЬЕ рдЬрд╛рдБрдЪреЗрдВ</button>
      </div>

      <div id="feedback" aria-live="polite"></div>
      <div id="score"></div>

      <div style="margin-top:12px">
        <button id="logoutBtn" class="warn">ЁЯФТ рд▓реЙрдЧрдЖрдЙрдЯ рдФрд░ рд░рд┐рдкреЛрд░реНрдЯ рднреЗрдЬреЗрдВ</button>
      </div>

      <div class="small">рд╕реБрдЭрд╛рд╡: Chrome (desktop) рдкрд░ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ тАФ рдорд╛рдЗрдХреНрд░реЛрдлрд╝реЛрди рдЕрдиреБрдорддрд┐ рджреЗрдВред</div>
    </div>
  </div>

<script>
/* =============================
   CONFIG - change only these
   ============================= */
// REPORT_URL: your deployed Apps Script URL (echo/exect endpoint)
const REPORT_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjCiIrW_GqD34UFh4qt0VcQC7Q4lTmQ9UFPSHNM1Iq37medCY1OzfZA95gJDcdthS_Ax2hEhlqG5ZAr3TSxrJVq6znDk8GuaeYGke5DFVR5QuIYsDtes_M9N3PzsVgyt6PujEKsYGAbYMZeLBr7btF2z5Ggv3Crjr-469VOrAdq3vtTAv7mb0utJwdrZK-ige6P_1MHPT5PjigP_ws0xWFl4XxeLeccbzPixQw3LixBYLyWvkeo1EOX5WkoRs9TM5DriRLZdohSUxSuKi3eOmgEAW1UpGFm2AjKiWrQ&lib=MJtJLyBLhYJ-I8iv1Kb4TmqdLM6UFQ5vk";

// Replace if you want auto WhatsApp open on logout (optional)
const WHATSAPP_NUMBER = ""; // e.g. "91999489XXXX" or empty to disable opening WhatsApp

/* =============================
   QUESTIONS (mixed set - 30)
   Keep wording consistent with your book
   ============================= */
const vachanQuestions = [
  { word: "рдХрд┐рддрд╛рдм", answers:["рдХрд┐рддрд╛рдмреЗрдВ","рдХрд┐рддрд╛рдмреЗ"] },
  { word: "рд▓рдбрд╝рдХрд╛", answers:["рд▓рдбрд╝рдХреЗ","рд▓рдбрд╝рдХреЗрдВ"] },
  { word: "рд▓рдбрд╝рдХреА", answers:["рд▓рдбрд╝рдХрд┐рдпрд╛рдБ","рд▓рдбрд╝рдХрд┐рдпрд╛рдВ","рд▓рдбрд╝рдХрд┐рдпрд╛рдБ"] },
  { word: "рдлреВрд▓", answers:["рдлреВрд▓"] },
  { word: "рдлрд▓", answers:["рдлрд▓"] },
  { word: "рд╕реЗрдм", answers:["рд╕реЗрдм"] },
  { word: "рдХрдорд░рд╛", answers:["рдХрдорд░реЗ"] },
  { word: "рдмрдЪреНрдЪрд╛", answers:["рдмрдЪреНрдЪреЗ"] },
  { word: "рдЖрдо", answers:["рдЖрдо"] },
  { word: "рдкреБрд╕реНрддрдХ", answers:["рдкреБрд╕реНрддрдХреЗрдВ","рдкреБрд╕реНрддрдХреЛрдВ"] },
  { word: "рдХреБрд░реНрд╕реА", answers:["рдХреБрд░реНрд╕рд┐рдпрд╛рдБ","рдХреБрд░реНрд╕рд┐рдпрд╛рдВ"] },
  { word: "рдирджреА", answers:["рдирджрд┐рдпрд╛рдБ","рдирджрд┐рдпрд╛рдВ"] },
  { word: "рдШрд░", answers:["рдШрд░"] },
  { word: "рдкреЗрдбрд╝", answers:["рдкреЗрдбрд╝"] },
  { word: "рдЦрд┐рд▓рд╛рдбрд╝реА", answers:["рдЦрд┐рд▓рд╛рдбрд╝реА"] }
];

const lingPairs = [
  ["рд░рд╛рдЬрд╛","рд░рд╛рдиреА"],
  ["рд╢реЗрд░","рд╢реЗрд░рдиреА"],
  ["рдкрддрд┐","рдкрддреНрдиреА"],
  ["рдирд╛рдирд╛","рдирд╛рдиреА"],
  ["рдореБрд░реНрдЧрд╛","рдореБрд░реНрдЧреА"],
  ["рдкреБрддреНрд░","рдкреБрддреНрд░реА"],
  ["рдЕрдзреНрдпрд╛рдкрдХ","рдЕрдзреНрдпрд╛рдкрд┐рдХрд╛"],
  ["рд╕реЗрда","рд╕реЗрдард╛рдиреА"],
  ["рднрд╛рдИ","рдмрд╣рди"],
  ["рдмреЗрдЯрд╛","рдмреЗрдЯреА"],
  ["рдЖрджрдореА","рдФрд░рдд"],
  ["рдкреНрд░рд╡рдХреНрддрд╛","рдкреНрд░рд╡рдХреНрддрд╛ (рд╕реНрддреНрд░реА)"] // placeholder if book has different
];

// Build questions array (15 vachan + 15 ling)
function buildPool(){
  const pool=[];
  // choose up to 15 vachan (if less, repeat shuffle to fill)
  shuffle(vachanQuestions);
  for(let i=0;i<15;i++){ pool.push({type:'vachan', ...vachanQuestions[i % vachanQuestions.length]}); }
  // build 15 ling from pairs (one direction randomly)
  const lingList=[];
  lingPairs.forEach(([m,f])=>{
    if(Math.random()<0.5) lingList.push({type:'ling', word:m, ask:'рд╕реНрддреНрд░реАрд▓рд┐рдВрдЧ', answers:[f]});
    else lingList.push({type:'ling', word:f, ask:'рдкреБрд▓реНрд▓рд┐рдВрдЧ', answers:[m]});
  });
  shuffle(lingList);
  for(let i=0;i<15;i++) pool.push(lingList[i % lingList.length]);
  shuffle(pool);
  return pool;
}

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* =============================
   UI Elements
   ============================= */
const loginArea = document.getElementById('loginArea');
const quizArea = document.getElementById('quizArea');
const loginBtn = document.getElementById('loginBtn');
const userNameInput = document.getElementById('userName');
const loginMsg = document.getElementById('loginMsg');

const questionDiv = document.getElementById('question');
const answerInput = document.getElementById('answer');
const startBtn = document.getElementById('startBtn');
const micBtn = document.getElementById('micBtn');
const passBtn = document.getElementById('passBtn');
const replayBtn = document.getElementById('replayBtn');
const checkBtn = document.getElementById('checkBtn');
const feedbackDiv = document.getElementById('feedback');
const scoreDiv = document.getElementById('score');
const logoutBtn = document.getElementById('logoutBtn');
const voiceWarningEl = document.getElementById('voiceWarning');

/* =============================
   State
   ============================= */
let pool = [];
let current = 0;
let score = 0;
let userName = '';
let recognition = null;
let listening = false;
let lastPrompt = '';
let chosenVoice = null;

/* =============================
   Voice & matching helpers
   ============================= */
function pickFemaleHindiVoice(){
  const voices = speechSynthesis.getVoices();
  if(!voices || voices.length===0) return null;
  const hi = voices.filter(v => (v.lang||'').toLowerCase().startsWith('hi'));
  const hints = ['female','aditi','shruti','google','ananya','aarya'];
  let pick = hi.find(v => hints.some(h => (v.name||'').toLowerCase().includes(h)));
  if(!pick) pick = hi[0] || voices[0];
  return pick;
}
function speak(text, onend){
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'hi-IN'; u.rate = 0.95;
    if(!chosenVoice) chosenVoice = pickFemaleHindiVoice();
    if(chosenVoice) u.voice = chosenVoice;
    if(onend) u.onend = onend;
    speechSynthesis.speak(u);
    lastPrompt = text;
  }catch(e){ console.warn(e); }
}

/* tolerant Hindi normalization & similarity */
function normalizeHindi(s){
  if(!s) return '';
  s = s.toString().normalize('NFD');
  s = s.replace(/[рдБрдВ]/g,'рдВ').replace(/[реЙреЛреМ]/g,'реЛ').replace(/[реИреЗ]/g,'реЗ')
       .replace(/[реГ]/g,'рд░').replace(/[реАрд┐]/g,'рд┐').replace(/[реВреБ]/g,'реБ')
       .replace(/[^\u0900-\u097F]/g,'').replace(/реН+/g,'');
  return s;
}
function lcsLen(a,b){
  const n=a.length, m=b.length;
  if(n===0||m===0) return 0;
  const dp=Array.from({length:n+1}, ()=> Array(m+1).fill(0));
  for(let i=1;i<=n;i++) for(let j=1;j<=m;j++) dp[i][j] = (a[i-1]===b[j-1]) ? dp[i-1][j-1]+1 : Math.max(dp[i-1][j], dp[i][j-1]);
  return dp[n][m];
}
function isGoodMatch(user, expected){
  const u = normalizeHindi(user);
  const e = normalizeHindi(expected);
  if(!u || !e) return false;
  if(e === 'рд╕реЗрдм') return u === 'рд╕реЗрдм'; // strict
  if(u === e) return true;
  const sim = lcsLen(u,e) / Math.max(u.length, e.length);
  return (sim >= 0.7 && u.length >= Math.max(1, e.length-1));
}

/* =============================
   Quiz flow
   ============================= */
function initForUser(name){
  userName = name;
  // mark user cannot retake later on same browser unless logout clears
  // (we'll set quiz_done_for_<name> when they logout)
  pool = buildPool();
  current = 0;
  score = 0;
  feedbackDiv.textContent = '';
  scoreDiv.textContent = '';
  answerInput.value = '';
  chosenVoice = pickFemaleHindiVoice();
}

function showQuestion(){
  if(current >= pool.length){ finishQuiz(); return; }
  const q = pool[current];
  let prompt;
  if(q.type === 'vachan') prompt = `рд╡рдЪрди рдмрджрд▓рд┐рдП: ${q.word} рдХрд╛ рдмрд╣реБрд╡рдЪрди рдмрддрд╛рдЗрдП`;
  else prompt = `рд▓рд┐рдВрдЧ рдмрджрд▓рд┐рдП: ${q.word} рдХрд╛ ${q.ask} рдмрддрд╛рдЗрдП`;
  questionDiv.textContent = prompt;
  answerInput.value = '';
  answerInput.disabled = false;
  passBtn.disabled = false;
  replayBtn.disabled = false;
  checkBtn.disabled = false;
  speak(prompt);
}

function onCorrect(){
  score++;
  feedbackDiv.style.color = '#1a7f3a';
  feedbackDiv.textContent = 'тЬЕ рд╕рд╣реА рдЙрддреНрддрд░!';
  speak('рдмрд╣реБрдд рдмрдврд╝рд┐рдпрд╛, рд╕рд╣реА рдЙрддреНрддрд░!', ()=> setTimeout(()=>{ current++; showQuestion(); }, 2000)); // 2s delay
}

function onWrong(){
  feedbackDiv.style.color = '#c00';
  feedbackDiv.textContent = 'тЭМ рдЧрд▓рдд рдЙрддреНрддрд░! рдлрд┐рд░ рд╕реЗ рдмреЛрд▓реЗрдВ рдпрд╛ рдкрд╛рд╕ рджрдмрд╛рдПрдБред';
  speak('рдЧрд▓рдд рдЙрддреНрддрд░');
}

/* =============================
   Buttons & events
   ============================= */
startBtn.onclick = ()=>{
  // start quiz (but ensure user logged in)
  if(!userName){ alert('рдХреГрдкрдпрд╛ рдкрд╣рд▓реЗ рд▓реЙрдЧрд┐рди рдХрд░реЗрдВ'); return; }
  current = 0; score = 0; shuffle(pool);
  showQuestion();
};

checkBtn.onclick = ()=>{
  const v = (answerInput.value || '').trim();
  if(!v){ feedbackDiv.textContent = 'рдХреГрдкрдпрд╛ рдЙрддреНрддрд░ рджреЗрдВ'; return; }
  const q = pool[current];
  const expected = q.answers || q._expected || [];
  const ok = expected.some(e => isGoodMatch(v,e));
  if(ok) onCorrect(); else onWrong();
};

passBtn.onclick = ()=>{ current++; showQuestion(); };
replayBtn.onclick = ()=>{ if(lastPrompt) speak(lastPrompt); };

/* ENTER to check */
answerInput.addEventListener('keydown', e => { if(e.key === 'Enter') checkBtn.click(); });

/* =============================
   SpeechRecognition setup
   ============================= */
try{
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(Rec){
    recognition = new Rec();
    recognition.lang = 'hi-IN';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.onresult = e => {
      // wait 1s to stabilize (helps short words)
      setTimeout(()=>{
        const txt = e.results[0][0].transcript.trim();
        answerInput.value = txt;
        // check
        const q = pool[current];
        const expected = q.answers || q._expected || [];
        const ok = expected.some(ev => isGoodMatch(txt,ev));
        if(ok) onCorrect(); else onWrong();
      }, 1000);
    };
    recognition.onerror = ev => { feedbackDiv.textContent = 'ЁЯОЩя╕П рддреНрд░реБрдЯрд┐: '+ (ev.error || 'error'); listening=false; micBtn.textContent='ЁЯОд рдмреЛрд▓реЗрдВ'; };
    recognition.onend = ()=> { listening=false; micBtn.textContent='ЁЯОд рдмреЛрд▓реЗрдВ'; };
    micBtn.onclick = ()=>{
      if(!pool.length){ feedbackDiv.textContent='рдХреГрдкрдпрд╛ рдкрд╣рд▓реЗ рдХреНрд╡рд┐рдЬрд╝ рдкреНрд░рд╛рд░рдВрдн рдХрд░реЗрдВ'; return; }
      if(listening){ try{ recognition.stop(); }catch(e){} listening=false; micBtn.textContent='ЁЯОд рдмреЛрд▓реЗрдВ'; }
      else { recognition.start(); listening=true; micBtn.textContent='тП╣ рд░реЛрдХреЗрдВ'; feedbackDiv.textContent=''; }
    };
    micBtn.disabled = false;
  } else {
    micBtn.disabled = true; micBtn.textContent='рдорд╛рдЗрдХ рдирд╣реАрдВ';
  }
}catch(e){ console.warn(e); micBtn.disabled=true; micBtn.textContent='рдорд╛рдЗрдХ рддреНрд░реБрдЯрд┐'; }

/* =============================
   Finish & logout reporting
   ============================= */
function finishQuiz(){
  questionDiv.textContent = 'рдХреНрд╡рд┐рдЬрд╝ рд╕рдорд╛рдкреНрдд!';
  answerInput.disabled = true;
  passBtn.disabled = micBtn.disabled = replayBtn.disabled = checkBtn.disabled = true;
  scoreDiv.textContent = `рдЖрдкрдХрд╛ рд╕реНрдХреЛрд░: ${score} / ${pool.length}`;
  speak(`${score} рдореЗрдВ рд╕реЗ ${pool.length}`);
}

logoutBtn.onclick = async ()=>{
  // set mark so same name cannot use again on this browser
  if(userName) localStorage.setItem('quiz_done_for_'+userName, 'true');

  // prepare payload
  const payload = {
    action: "logout",
    name: userName,
    score: score,
    attempted: pool.length,
    remarks: ""
  };

  // show temporary message
  feedbackDiv.style.color='#333';
  feedbackDiv.textContent = 'рд░рд┐рдкреЛрд░реНрдЯ рднреЗрдЬреА рдЬрд╛ рд░рд╣реА рд╣реИ...';

  // POST to Apps Script
  try{
    const res = await fetch(REPORT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    // some script endpoints return JSON or text - we ignore details
    feedbackDiv.textContent = 'рд░рд┐рдкреЛрд░реНрдЯ рднреЗрдЬ рджреА рдЧрдпреАред (рдпрджрд┐ рдХреЛрдИ рджреЗрд░реА рд╣реЛ рддреЛ рдмрд╛рдж рдореЗрдВ рдЬрд╛рдБрдЪреЗрдВ)ред';
  }catch(err){
    console.warn('report send failed', err);
    feedbackDiv.style.color = '#c00';
    feedbackDiv.textContent = 'рд░рд┐рдкреЛрд░реНрдЯ рднреЗрдЬрдиреЗ рдореЗрдВ рд╕рдорд╕реНрдпрд╛ рдЖрдИ тАФ рдХреГрдкрдпрд╛ Chrome рдкрд░ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред';
  }

  // Optionally open WhatsApp chat with prefilled message (if number configured)
  if(WHATSAPP_NUMBER && WHATSAPP_NUMBER.length>4){
    const waMsg = encodeURIComponent(`рдирдорд╕реНрддреЗ! рдореИрдВ ${userName} рд╣реВрдБред рдореЗрд░рд╛ рд╕реНрдХреЛрд░ ${score}/${pool.length} рд╣реИред`);
    window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${waMsg}`, '_blank');
  }

  // clear session user and go back to login screen after short delay
  setTimeout(()=>{
    userName = '';
    document.getElementById('userName').value = '';
    quizArea.style.display = 'none';
    loginArea.style.display = 'block';
  }, 1200);
};

/* =============================
   Login click
   ============================= */
loginBtn.onclick = ()=>{
  const name = (userNameInput.value || '').trim();
  if(!name){ loginMsg.textContent = 'рдХреГрдкрдпрд╛ рдирд╛рдо рджрд░реНрдЬ рдХрд░реЗрдВ'; return; }
  // If already done on this browser
  if(localStorage.getItem('quiz_done_for_'+name)){
    loginMsg.textContent = 'рдЖрдкрдиреЗ рдкрд╣рд▓реЗ рд╣реА рдпрд╣ рдХреНрд╡рд┐рдЬрд╝ рджреЗ рджрд┐рдпрд╛ рд╣реИред';
    return;
  }
  loginMsg.textContent = '';
  initForUser(name);
  loginArea.style.display = 'none';
  quizArea.style.display = 'block';

  // detect whether hi-IN voice exists; show warning (left) for 10s if missing
  setTimeout(()=>{
    const voices = speechSynthesis.getVoices();
    const hasHi = (voices||[]).some(v => (v.lang||'').toLowerCase().startsWith('hi'));
    if(!hasHi){
      voiceWarningEl.style.display = 'block';
      voiceWarningEl.textContent = "ЁЯФ┤ рдЖрдкрдХреЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдореЗрдВ рд╣рд┐рдВрджреА рдЖрд╡рд╛рдЬрд╝ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд░рд╣реА рд╣реИред рдХреГрдкрдпрд╛ Chrome рдпрд╛ Edge рдореЗрдВ рджреЛрдмрд╛рд░рд╛ рдЦреЛрд▓реЗрдВред\nЁЯФ┤ Hindi voice not working in your browser. Please open again in Chrome or Edge.";
      setTimeout(()=>{ voiceWarningEl.style.display = 'none'; }, 10000);
    }
  }, 500);

  // prepare pool
  pool = buildPool();
};

/* =============================
   On page load: resume if already logged in
   ============================= */
window.addEventListener('load', ()=> {
  // If user has active session
  const active = localStorage.getItem('quiz_user_name');
  if(active){
    userName = active;
    initForUser(userName);
    loginArea.style.display = 'none';
    quizArea.style.display = 'block';
  } else {
    // show login
    loginArea.style.display = 'block';
    quizArea.style.display = 'none';
  }
  // ensure voices loaded
  speechSynthesis.onvoiceschanged = ()=> { chosenVoice = pickFemaleHindiVoice(); };
});

/* expose a simple function for debug in console */
window._DEBUG_getState = ()=>({ userName, current, score, poolSize: pool.length });

</script>
</body>
</html>
