<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>рд╣рд┐рдВрджреА рдСрдбрд┐рдпреЛ рдХреНрд╡рд┐рдЬрд╝ тАФ рд▓рд┐рдВрдЧ & рд╡рдЪрди (Final)</title>
<style>
  body{font-family:'Noto Sans Devanagari',system-ui,Arial,sans-serif;background:#fff;margin:0;padding:20px;text-align:center;color:#111}
  h1{color:#b71c1c;margin:6px 0 12px}
  #question{font-size:1.35rem;margin:18px 0;min-height:56px}
  input#answer{padding:10px;font-size:16px;width:88%;max-width:520px;border:1px solid #ccc;border-radius:6px;text-align:center}
  .controls{margin:14px 0;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
  button{padding:10px 14px;border-radius:8px;border:none;background:#1565c0;color:#fff;font-size:15px;cursor:pointer}
  button.secondary{background:#6c757d}
  #feedback{margin-top:12px;font-weight:700;min-height:28px}
  #score{margin-top:12px;color:#0b6623;font-weight:700}
  .small{font-size:12px;color:#666;margin-top:10px}
  /* warning styling - left aligned below start button area */
  #voiceWarning{color:#c00;text-align:left;margin-top:8px;white-space:pre-line;display:none}
</style>
</head>
<body>
  <h1>рд╣рд┐рдВрджреА рдСрдбрд┐рдпреЛ рдХреНрд╡рд┐рдЬрд╝ тАФ рд▓рд┐рдВрдЧ & рд╡рдЪрди</h1>

  <div id="question">рдХреНрд╡рд┐рдЬрд╝ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП "рд╢реБрд░реВ рдХрд░реЗрдВ" рджрдмрд╛рдПрдБ</div>

  <div>
    <input id="answer" placeholder="рдЙрддреНрддрд░ рдмреЛрд▓рд┐рдП рдпрд╛ рд▓рд┐рдЦрд┐рдП (Enter рд╕реЗ рдЬрд╛рдБрдЪреЗрдВ)" disabled>
  </div>

  <div class="controls">
    <button id="startBtn">тЦ╢я╕П рд╢реБрд░реВ рдХрд░реЗрдВ</button>
    <button id="resetBtn" class="secondary">ЁЯФД рд░реАрд╕реЗрдЯ</button>
    <button id="micBtn" disabled>ЁЯОд рдмреЛрд▓реЗрдВ</button>
    <button id="passBtn" class="secondary" disabled>тПн рдкрд╛рд╕</button>
    <button id="replayBtn" class="secondary" disabled>ЁЯФБ рдлрд┐рд░ рд╕реБрдиреЗрдВ</button>
    <button id="checkBtn">тЬЕ рдЬрд╛рдБрдЪреЗрдВ</button>
  </div>

  <!-- Warning appears left-aligned below the start button area -->
  <div id="voiceWarning">ЁЯФ┤ рдЖрдкрдХреЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдореЗрдВ рд╣рд┐рдВрджреА рдЖрд╡рд╛рдЬрд╝ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд░рд╣реА рд╣реИред рдХреГрдкрдпрд╛ Chrome рдпрд╛ Edge рдореЗрдВ рджреЛрдмрд╛рд░рд╛ рдЦреЛрд▓реЗрдВред
ЁЯФ┤ Hindi voice not working in your browser. Please open again in Chrome or Edge.</div>

  <div id="feedback"></div>
  <div id="score"></div>
  <div class="small">Chrome (desktop / HTTPS/localhost) рдкрд░ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ тАФ рдкрд╣рд▓реА рдмрд╛рд░ рдорд╛рдЗрдХреНрд░реЛрдлрд╝реЛрди рдЕрдиреБрдорддрд┐ рджреЗрдВред</div>

<script>
/* ---------------------------
  FINAL QUESTION SETS (30)
  15 vachan + 15 ling (one direction per pair)
  --------------------------- */
const vachanQuestions = [
  { word: "рдХрд┐рддрд╛рдм", answers:["рдХрд┐рддрд╛рдмреЗрдВ","рдХрд┐рддрд╛рдмреЗ"] },
  { word: "рд▓рдбрд╝рдХрд╛", answers:["рд▓рдбрд╝рдХреЗ","рд▓рдбрд╝рдХреЗрдВ"] },
  { word: "рд▓рдбрд╝рдХреА", answers:["рд▓рдбрд╝рдХрд┐рдпрд╛рдБ","рд▓рдбрд╝рдХрд┐рдпрд╛рдВ","рд▓рдбрд╝рдХрд┐рдпреЙрдВ"] },
  { word: "рд░рд╛рдЬрд╛", answers:["рд░рд╛рдЬреЗ","рд░рд╛рдЬрд╛рдУрдВ","рд░рд╛рдЬреЗ"] },
  { word: "рдмрд╛рд▓рдХ", answers:["рдмрд╛рд▓рдХ"] },
  { word: "рдлреВрд▓", answers:["рдлреВрд▓"] },
  { word: "рдмрдЪреНрдЪрд╛", answers:["рдмрдЪреНрдЪреЗ"] },
  { word: "рдкреБрд╕реНрддрдХ", answers:["рдкреБрд╕реНрддрдХреЗрдВ","рдкреБрд╕реНрддрдХреЛрдВ"] },
  { word: "рдкрдХреНрд╖реА", answers:["рдкрдХреНрд╖реА"] },
  { word: "рдкреЗрдбрд╝", answers:["рдкреЗрдбрд╝"] },
  { word: "рд╕реИрдирд┐рдХ", answers:["рд╕реИрдирд┐рдХ"] },
  { word: "рдлрд▓", answers:["рдлрд▓"] },
  { word: "рдХрдорд▓", answers:["рдХрдорд▓"] },
  { word: "рдЦрд┐рд▓рд╛рдбрд╝реА", answers:["рдЦрд┐рд▓рд╛рдбрд╝реА"] },
  { word: "рдЖрдо", answers:["рдЖрдо"] }
];

const lingPairs = [
  ["рд░рд╛рдЬрд╛","рд░рд╛рдиреА"],
  ["рд╢реЗрд░","рд╢реЗрд░рдиреА"],
  ["рдкрддрд┐","рдкрддреНрдиреА"],
  ["рдирд╛рдирд╛","рдирд╛рдиреА"],
  ["рдореБрд░реНрдЧрд╛","рдореБрд░реНрдЧреА"],
  ["рдкреБрддреНрд░","рдкреБрддреНрд░реА"],
  ["рдЕрдзреНрдпрд╛рдкрдХ","рдЕрдзреНрдпрд╛рдкрд┐рдХрд╛"],
  ["рд╕реЗрда","рд╕реЗрдард╛рдиреА"]
];

/* Build ling questions */
function buildLingQuestions(){
  const out=[];
  lingPairs.forEach(([m,f])=>{
    if(Math.random() < 0.5) out.push({ type:'ling', word:m, ask:'рд╕реНрддреНрд░реАрд▓рд┐рдВрдЧ', answers:[f] });
    else out.push({ type:'ling', word:f, ask:'рдкреБрд▓реНрд▓рд┐рдВрдЧ', answers:[m] });
  });
  return out;
}

/* Build pool and shuffle */
function buildPool(){
  const pool = [];
  vachanQuestions.forEach(q => pool.push({ type:'vachan', word:q.word, answers:q.answers }));
  const l = buildLingQuestions();
  l.forEach(q => pool.push(q));
  shuffle(pool);
  return pool;
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* ---------------------------
  Voice helpers and detection
  --------------------------- */
let chosenVoice = null;
function pickFemaleHindiVoice(){
  const voices = speechSynthesis.getVoices();
  if(!voices || voices.length===0) return null;
  const hi = voices.filter(v => (v.lang||'').toLowerCase().startsWith('hi'));
  const hints = ['female','aditi','shruti','google','samantha','ananya','aarya'];
  let pick = hi.find(v => hints.some(h => (v.name||'').toLowerCase().includes(h)));
  if(!pick) pick = hi[0] || voices[0];
  return pick;
}
function speak(text, onend){
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'hi-IN';
    u.rate = 0.95;
    if(!chosenVoice) chosenVoice = pickFemaleHindiVoice();
    if(chosenVoice) u.voice = chosenVoice;
    if(onend) u.onend = onend;
    speechSynthesis.speak(u);
  }catch(e){ console.warn(e); }
}

/* Check if hi-IN voice available */
function hasHindiVoice(){
  const voices = speechSynthesis.getVoices();
  if(!voices || voices.length===0) return false;
  for(const v of voices){
    if((v.lang||'').toLowerCase().startsWith('hi')) return true;
  }
  return false;
}

/* Show warning (left-aligned) below controls; auto-hide after 10s */
const voiceWarningEl = document.getElementById('voiceWarning');
let warningTimeout = null;
function showVoiceWarning(){
  voiceWarningEl.style.display = 'block';
  // ensure left alignment (it already is set text-align:left in CSS)
  if(warningTimeout) clearTimeout(warningTimeout);
  warningTimeout = setTimeout(()=> { voiceWarningEl.style.display = 'none'; warningTimeout = null; }, 10000);
}

/* Also handle voiceschanged event so detection works as soon as voices load */
speechSynthesis.onvoiceschanged = ()=> {
  // nothing auto тАФ we detect on start press too
};

/* ---------------------------
  Matching helpers (tolerant Hindi)
  --------------------------- */
function normalizeHindi(s){
  if(!s) return '';
  s = s.toString().normalize('NFD');
  s = s.replace(/[рдБрдВ]/g,'рдВ');
  s = s.replace(/[реЙреЛреМ]/g,'реЛ');
  s = s.replace(/[реИреЗ]/g,'реЗ');
  s = s.replace(/[реГ]/g,'рд░');
  s = s.replace(/[реАрд┐]/g,'рд┐');
  s = s.replace(/[реВреБ]/g,'реБ');
  s = s.replace(/[^\u0900-\u097F]/g,'');
  s = s.replace(/реН+/g,'');
  return s;
}
function lcsLen(a,b){
  const n=a.length, m=b.length;
  if(n===0 || m===0) return 0;
  const dp = Array.from({length:n+1}, ()=> Array(m+1).fill(0));
  for(let i=1;i<=n;i++){
    for(let j=1;j<=m;j++){
      if(a[i-1]===b[j-1]) dp[i][j] = dp[i-1][j-1] + 1;
      else dp[i][j] = Math.max(dp[i-1][j], dp[i][j-1]);
    }
  }
  return dp[n][m];
}
function isGoodMatch(userRaw, expectedRaw){
  const u = normalizeHindi(userRaw);
  const e = normalizeHindi(expectedRaw);
  if(!u || !e) return false;
  if(e === 'рд╕реЗрдм') return u === 'рд╕реЗрдм'; // strict
  if(u === e) return true;
  const lcs = lcsLen(u,e);
  const sim = lcs / Math.max(u.length, e.length);
  if(sim >= 0.7 && u.length >= Math.max(1, e.length - 1)) return true;
  return false;
}
function matchAnswer(userRaw, expectedList){
  for(const ex of expectedList) if(isGoodMatch(userRaw, ex)) return true;
  return false;
}

/* ---------------------------
  UI & quiz flow
  --------------------------- */
const questionDiv = document.getElementById('question');
const answerInput = document.getElementById('answer');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const micBtn = document.getElementById('micBtn');
const passBtn = document.getElementById('passBtn');
const replayBtn = document.getElementById('replayBtn');
const checkBtn = document.getElementById('checkBtn');
const feedbackDiv = document.getElementById('feedback');
const scoreDiv = document.getElementById('score');

let pool = [], index = 0, score = 0;
let recognition = null, listening = false;

/* prepare */
function prepareQuiz(){
  pool = buildPool();
  index = 0; score = 0;
}

/* show question and speak */
function showQuestion(){
  if(index >= pool.length){ finishQuiz(); return; }
  const q = pool[index];
  const prompt = (q.type === 'vachan')
    ? `рд╡рдЪрди рдмрджрд▓рд┐рдП: ${q.word} рдХрд╛ рдмрд╣реБрд╡рдЪрди рдмрддрд╛рдЗрдП`
    : `рд▓рд┐рдВрдЧ рдмрджрд▓рд┐рдП: ${q.word} рдХрд╛ ${q.ask} рдмрддрд╛рдЗрдП`;
  questionDiv.textContent = prompt;
  answerInput.value = '';
  feedbackDiv.textContent = '';
  answerInput.disabled = false;
  passBtn.disabled = false;
  replayBtn.disabled = false;
  speak(prompt);
}

/* start click: also detect Hindi TTS; show warning if missing (and runs every start click) */
startBtn.onclick = ()=>{
  // detect Hindi voice availability; if missing show warning
  if(!hasHindiVoice()){
    showVoiceWarning();
  }
  prepareQuiz();
  chosenVoice = pickFemaleHindiVoice();
  startBtn.disabled = true;
  resetBtn.disabled = false;
  answerInput.disabled = false;
  micBtn.disabled = false;
  passBtn.disabled = false;
  replayBtn.disabled = false;
  checkBtn.disabled = false;
  scoreDiv.textContent = '';
  speak("рдЪрд▓реЛ, рд╣рдо рд╣рд┐рдВрджреА рдкреНрд░рд╢реНрдиреЛрддреНрддрд░реА рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВред", ()=> setTimeout(showQuestion, 700));
};

/* reset */
resetBtn.onclick = ()=>{
  if(recognition && listening){ try{ recognition.stop(); }catch(e){} listening=false; micBtn.textContent='ЁЯОд рдмреЛрд▓реЗрдВ'; }
  prepareQuiz();
  answerInput.value = '';
  feedbackDiv.textContent = '';
  scoreDiv.textContent = '';
  startBtn.disabled = false;
  answerInput.disabled = true;
  micBtn.disabled = true;
  passBtn.disabled = true;
  replayBtn.disabled = true;
  checkBtn.disabled = false;
  questionDiv.textContent = 'рдХреНрд╡рд┐рдЬрд╝ рд░реАрд╕реЗрдЯ рд╣реБрдЖ тАФ "рд╢реБрд░реВ рдХрд░реЗрдВ" рджрдмрд╛рдПрдБ';
};

/* handle answer submission */
function handleAnswerSubmission(userText){
  const q = pool[index];
  const expected = q.answers;
  if(matchAnswer(userText, expected)){
    feedbackDiv.style.color = '#1a7f3a';
    feedbackDiv.textContent = 'тЬЕ рдмрд╣реБрдд рдмрдврд╝рд┐рдпрд╛, рд╕рд╣реА рдЬрд╡рд╛рдм!';
    speak('рдмрд╣реБрдд рдмрдврд╝рд┐рдпрд╛, рд╕рд╣реА рдЬрд╡рд╛рдм!', ()=>{
      score++; index++;
      setTimeout(showQuestion, 2000); // 2s delay after correct as requested
    });
  } else {
    feedbackDiv.style.color = '#c00';
    feedbackDiv.textContent = 'тЭМ рдлрд┐рд░ рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ!';
    speak('рдлрд┐рд░ рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ!');
  }
}

/* check typed */
checkBtn.onclick = ()=>{
  const user = answerInput.value.trim();
  if(!user){ feedbackDiv.textContent = 'рдХреГрдкрдпрд╛ рдЙрддреНрддрд░ рдмреЛрд▓реЗрдВ рдпрд╛ рд▓рд┐рдЦреЗрдВред'; return; }
  handleAnswerSubmission(user);
};

/* pass */
passBtn.onclick = ()=>{
  speak('рдЕрдЧрд▓рд╛ рдкреНрд░рд╢реНрди рд╕реБрдирд┐рдПред', ()=>{
    feedbackDiv.style.color = '#555';
    feedbackDiv.textContent = 'тПн рдкреНрд░рд╢реНрди рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЧрдпрд╛ред';
    index++; setTimeout(showQuestion, 700);
  });
};

/* replay */
replayBtn.onclick = ()=> { if(questionDiv.textContent) speak(questionDiv.textContent); };

/* finish: show and speak only score as "<score> рдореЗрдВ рд╕реЗ <total>" */
function finishQuiz(){
  questionDiv.textContent = 'рдХреНрд╡рд┐рдЬрд╝ рд╕рдорд╛рдкреНрдд!';
  feedbackDiv.textContent = '';
  const total = pool.length;
  scoreDiv.textContent = `рдЖрдкрдХрд╛ рд╕реНрдХреЛрд░: ${score} / ${total}`;
  speak(`${score} рдореЗрдВ рд╕реЗ ${total}`);
  answerInput.disabled = true;
  micBtn.disabled = true;
  passBtn.disabled = true;
  replayBtn.disabled = true;
  checkBtn.disabled = true;
  startBtn.disabled = false;
}

/* ---------------------------
  Speech recognition (voice input)
  1s wait after result to stabilize short words
  --------------------------- */
try{
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(Rec){
    recognition = new Rec();
    recognition.lang = 'hi-IN';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = e => {
      setTimeout(()=>{
        const said = e.results[0][0].transcript.trim();
        answerInput.value = said;
        handleAnswerSubmission(said);
      }, 1000);
    };

    recognition.onerror = ev => {
      feedbackDiv.textContent = 'ЁЯОЩя╕П рддреНрд░реБрдЯрд┐: ' + (ev.error || 'error');
      listening = false; micBtn.textContent = 'ЁЯОд рдмреЛрд▓реЗрдВ';
    };

    recognition.onend = ()=> {
      listening = false; micBtn.textContent = 'ЁЯОд рдмреЛрд▓реЗрдВ';
    };

    micBtn.onclick = ()=>{
      if(!pool.length){ feedbackDiv.textContent = 'рдкрд╣рд▓реЗ "рд╢реБрд░реВ рдХрд░реЗрдВ" рджрдмрд╛рдПрдБред'; return; }
      if(listening){ try{ recognition.stop(); }catch(e){} listening=false; micBtn.textContent='ЁЯОд рдмреЛрд▓реЗрдВ'; }
      else { recognition.start(); listening=true; micBtn.textContent='тП╣ рд░реЛрдХреЗрдВ'; feedbackDiv.textContent=''; }
    };
  } else {
    micBtn.disabled = true;
    micBtn.textContent = 'рдорд╛рдЗрдХ рдирд╣реАрдВ';
  }
}catch(e){
  console.warn(e);
  micBtn.disabled = true;
  micBtn.textContent = 'рдорд╛рдЗрдХ рддреНрд░реБрдЯрд┐';
}

/* Enter to submit typed */
answerInput.addEventListener('keydown', ev => { if(ev.key === 'Enter') checkBtn.click(); });

/* initialize */
resetBtn.click();

</script>
</body>
</html>
