<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‚Äî ‡§≤‡§ø‡§Ç‡§ó & ‡§µ‡§ö‡§®</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
<style>
  body{font-family:'Noto Sans Devanagari',system-ui,Arial,sans-serif;background:#fffdf9;margin:0;padding:18px;text-align:center;color:#111}
  .container{max-width:920px;margin:0 auto}
  h1{color:#0d47a1;margin:8px 0 14px;font-weight:700}
  /* LOGIN */
  #loginBox{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:inline-block}
  input[type="text"]{padding:10px 12px;width:260px;border:2px solid #cfcfcf;border-radius:8px;font-size:16px}
  button.primary{background:#1565c0;color:#fff;border:none;padding:10px 16px;border-radius:8px;font-size:15px;cursor:pointer;margin:8px}
  button.secondary{background:#6c757d;color:#fff;border:none;padding:10px 14px;border-radius:8px;font-size:14px;cursor:pointer;margin:8px}

  /* QUIZ UI (original blue buttons look) */
  #quizArea{display:none;margin-top:10px}
  #questionText{font-size:1.4rem;margin:20px 0;min-height:56px;color:#0b3a67}
  input#answerInput{padding:10px;font-size:16px;width:80%;max-width:420px;border:2px solid #cfcfcf;border-radius:10px;text-align:center}
  .controls{margin:12px 0;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
  .btn{background:#1565c0;color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-size:15px}
  .btn.secondary{background:#6c757d}
  #feedbackText{margin-top:12px;font-size:1.1rem;font-weight:700;min-height:28px}
  #scoreBox{margin-top:14px;font-weight:700;color:#0b6623;font-size:1.15rem}
  #logoutBtn{background:#b71c1c;padding:8px 12px;border-radius:8px;color:#fff;border:none;cursor:pointer;margin-top:14px}
  .note{font-size:13px;color:#666;margin-top:8px}
</style>
</head>
<body>
  <div class="container">
    <h1>‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‚Äî ‡§≤‡§ø‡§Ç‡§ó & ‡§µ‡§ö‡§®</h1>

    <!-- LOGIN BOX -->
    <div id="loginBox" aria-live="polite">
      <div style="margin-bottom:10px"><strong>‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç (‡§®‡§æ‡§Æ)</strong></div>
      <input id="loginName" type="text" placeholder="‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç" autocomplete="off">
      <div style="margin-top:10px">
        <button id="loginBtn" class="primary">‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç</button>
      </div>
      <div id="loginMsg" class="note" style="color:#c00"></div>
    </div>

    <!-- QUIZ AREA -->
    <div id="quizArea">
      <div id="questionText">‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è "‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç" ‡§¶‡§¨‡§æ‡§è‡§Å</div>

      <input id="answerInput" placeholder="‡§â‡§§‡•ç‡§§‡§∞ ‡§¨‡•ã‡§≤‡•á‡§Ç ‡§Ø‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç (Enter ‡§∏‡•á ‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç)" />

      <div class="controls" style="margin-top:12px">
        <button id="startBtn" class="btn">‚ñ∂Ô∏è ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç</button>
        <button id="micBtn" class="btn">üé§ ‡§¨‡•ã‡§≤‡•á‡§Ç</button>
        <button id="passBtn" class="btn secondary">‡§™‡§æ‡§∏</button>
        <button id="replayBtn" class="btn secondary">üîÅ ‡§¶‡•ã‡§π‡§∞‡§æ‡§è‡§Å</button>
        <button id="checkBtn" class="btn">‚úÖ ‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç</button>
      </div>

      <div id="feedbackText"></div>
      <div id="scoreBox"></div>

      <div style="margin-top:12px">
        <button id="logoutBtn">üîí ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§î‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≠‡•á‡§ú‡•á‡§Ç</button>
      </div>

      <div class="note">Chrome (desktop/HTTPS) ‡§™‡§∞ ‡§∏‡§¨‡§∏‡•á ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‚Äî ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§™‡§∞ ‡§Æ‡§æ‡§á‡§ï‡•ç‡§∞‡•ã‡§´‡•ã‡§® ‡§î‡§∞ TTS ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§</div>
    </div>
  </div>

<script>
/* ============================
  CONFIG
  ============================ */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzp1lU00ynOgaAvOsu0mEyinlYEEc7YThD4QT8xfdOWyrxA0saMDn5FY32PSPUowr0B6A/exec";
/* If you ever redeploy Apps Script, replace SCRIPT_URL above with the new /exec URL */

/* ============================
  QUESTIONS (mixed ling + vachan exactly as before)
  Keep the same pool that we used previously (30 total).
  Replace or expand this array with your full set if you have extra items.
  ============================ */
const vachanQuestions = [
  { word: "‡§™‡§æ‡§†‡§∂‡§æ‡§≤‡§æ", answers:["‡§™‡§æ‡§†‡§∂‡§æ‡§≤‡§æ‡§è‡§Å","‡§™‡§æ‡§†‡§∂‡§æ‡§≤‡§æ‡§è‡§Ç","‡§™‡§æ‡§†‡§∂‡§æ‡§≤‡§æ‡•á"] },
  { word: "‡§Æ‡§æ‡§≤‡§æ", answers:["‡§Æ‡§æ‡§≤‡§æ‡§è‡§Å","‡§Æ‡§æ‡§≤‡§æ‡§è‡§Ç","‡§Æ‡§æ‡§≤‡§æ‡§Ø‡•á‡§Ç"] },
  { word: "‡§ö‡§ø‡§°‡§º‡§ø‡§Ø‡§æ", answers:["‡§ö‡§ø‡§°‡§º‡§ø‡§Ø‡§æ‡§è‡§Å","‡§ö‡§ø‡§°‡§º‡§ø‡§Ø‡§æ‡§è‡§Ç"] },
  { word: "‡§ó‡•Å‡§°‡§º‡§ø‡§Ø‡§æ", answers:["‡§ó‡•Å‡§°‡§º‡§ø‡§Ø‡§æ‡§Å","‡§ó‡•Å‡§°‡§º‡§ø‡§Ø‡§æ‡§Ç"] },
  { word: "‡§≤‡§°‡§º‡§ï‡•Ä", answers:["‡§≤‡§°‡§º‡§ï‡§ø‡§Ø‡§æ‡§Å","‡§≤‡§°‡§º‡§ï‡§ø‡§Ø‡§æ‡§Ç"] },
  { word: "‡§®‡§¶‡•Ä", answers:["‡§®‡§¶‡§ø‡§Ø‡§æ‡§Å","‡§®‡§¶‡§ø‡§Ø‡§æ‡§Ç"] },
  { word: "‡§∞‡•ã‡§ü‡•Ä", answers:["‡§∞‡•ã‡§ü‡§ø‡§Ø‡§æ‡§Å","‡§∞‡•ã‡§ü‡§ø‡§Ø‡§æ‡§Ç"] },
  { word: "‡§ó‡§æ‡§°‡§º‡•Ä", answers:["‡§ó‡§æ‡§°‡§º‡§ø‡§Ø‡§æ‡§Å","‡§ó‡§æ‡§°‡§º‡§ø‡§Ø‡•ã‡§Ç","‡§ó‡§æ‡§°‡§ø‡§Ø‡§æ‡§Å"] },
  { word: "‡§ï‡•Å‡§∞‡•ç‡§∏‡•Ä", answers:["‡§ï‡•Å‡§∞‡•ç‡§∏‡§ø‡§Ø‡§æ‡§Å","‡§ï‡•Å‡§∞‡•ç‡§∏‡§ø‡§Ø‡§æ‡§Ç"] },
  { word: "‡§ï‡§ø‡§§‡§æ‡§¨", answers:["‡§ï‡§ø‡§§‡§æ‡§¨‡•á‡§Ç","‡§ï‡§ø‡§§‡§æ‡§¨‡•á"] },
  { word: "‡§≤‡§°‡§º‡§ï‡§æ", answers:["‡§≤‡§°‡§º‡§ï‡•á","‡§≤‡§°‡§º‡§ï‡•á‡§Ç"] },
  { word: "‡§∞‡•Å‡§™‡§Ø‡§æ", answers:["‡§∞‡•Å‡§™‡§Ø‡•á","‡§∞‡•Å‡§™‡§è"] },
  { word: "‡§ï‡§Æ‡§∞‡§æ", answers:["‡§ï‡§Æ‡§∞‡•á","‡§ï‡§Æ‡§∞‡•ã‡§Ç"] },
  { word: "‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞", answers:["‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞‡•á‡§Ç","‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞‡•ã‡§Ç","‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞‡•á‡§Ç"] },
  { word: "‡§∏‡•á‡§¨", answers:["‡§∏‡•á‡§¨"] },
  { word: "‡§´‡•Ç‡§≤", answers:["‡§´‡•Ç‡§≤"] },
  { word: "‡§´‡§≤", answers:["‡§´‡§≤"] },
  { word: "‡§Ü‡§Æ", answers:["‡§Ü‡§Æ"] },
  { word: "‡§¨‡§ö‡•ç‡§ö‡§æ", answers:["‡§¨‡§ö‡•ç‡§ö‡•á"] },
  { word: "‡§™‡•Å‡§∏‡•ç‡§§‡§ï", answers:["‡§™‡•Å‡§∏‡•ç‡§§‡§ï‡•á‡§Ç","‡§™‡•Å‡§∏‡•ç‡§§‡§ï‡•á‡§Ç"] }
];

const lingQuestions = [
  { word: "‡§∞‡§æ‡§ú‡§æ", male:["‡§∞‡§æ‡§ú‡§æ"], female:["‡§∞‡§æ‡§®‡•Ä"] },
  { word: "‡§∞‡§æ‡§®‡•Ä", male:["‡§∞‡§æ‡§ú‡§æ"], female:["‡§∞‡§æ‡§®‡•Ä"] },
  { word: "‡§∂‡•á‡§∞", male:["‡§∂‡•á‡§∞"], female:["‡§∂‡•á‡§∞‡§®‡•Ä"] },
  { word: "‡§∂‡•á‡§∞‡§®‡•Ä", male:["‡§∂‡•á‡§∞"], female:["‡§∂‡•á‡§∞‡§®‡•Ä"] },
  { word: "‡§™‡§§‡§ø", male:["‡§™‡§§‡§ø"], female:["‡§™‡§§‡•ç‡§®‡•Ä"] },
  { word: "‡§™‡§§‡•ç‡§®‡•Ä", male:["‡§™‡§§‡§ø"], female:["‡§™‡§§‡•ç‡§®‡•Ä"] },
  { word: "‡§®‡§æ‡§®‡§æ", male:["‡§®‡§æ‡§®‡§æ"], female:["‡§®‡§æ‡§®‡•Ä"] },
  { word: "‡§®‡§æ‡§®‡•Ä", male:["‡§®‡§æ‡§®‡§æ"], female:["‡§®‡§æ‡§®‡•Ä"] },
  { word: "‡§Æ‡•Å‡§∞‡•ç‡§ó‡§æ", male:["‡§Æ‡•Å‡§∞‡•ç‡§ó‡§æ"], female:["‡§Æ‡•Å‡§∞‡•ç‡§ó‡•Ä"] },
  { word: "‡§Æ‡•Å‡§∞‡•ç‡§ó‡•Ä", male:["‡§Æ‡•Å‡§∞‡•ç‡§ó‡§æ"], female:["‡§Æ‡•Å‡§∞‡•ç‡§ó‡•Ä"] },
  { word: "‡§™‡•Å‡§§‡•ç‡§∞", male:["‡§™‡•Å‡§§‡•ç‡§∞"], female:["‡§™‡•Å‡§§‡•ç‡§∞‡•Ä"] },
  { word: "‡§™‡•Å‡§§‡•ç‡§∞‡•Ä", male:["‡§™‡•Å‡§§‡•ç‡§∞"], female:["‡§™‡•Å‡§§‡•ç‡§∞‡•Ä"] },
  { word: "‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§™‡§ï", male:["‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§™‡§ï"], female:["‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§™‡§ø‡§ï‡§æ"] },
  { word: "‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§™‡§ø‡§ï‡§æ", male:["‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§™‡§ï"], female:["‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§™‡§ø‡§ï‡§æ"] },
  { word: "‡§∏‡•á‡§†", male:["‡§∏‡•á‡§†"], female:["‡§∏‡•á‡§†‡§æ‡§®‡•Ä","‡§∏‡•á‡§†‡§®‡•Ä"] }
];

/* Merge and shuffle */
let questions = [];
vachanQuestions.forEach(q => questions.push({type:'vachan', ...q}));
lingQuestions.forEach(q => questions.push({type:'ling', ...q}));
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
shuffle(questions);

/* ============================
  State
  ============================ */
let current = 0;
let score = 0;
let lastSpoken = "";
let recognition = null;
let chosenVoice = null;

/* ============================
  UI elements
  ============================ */
const loginBox = document.getElementById('loginBox');
const loginName = document.getElementById('loginName');
const loginBtn = document.getElementById('loginBtn');
const loginMsg = document.getElementById('loginMsg');

const quizArea = document.getElementById('quizArea');
const questionText = document.getElementById('questionText');
const answerInput = document.getElementById('answerInput');
const startBtn = document.getElementById('startBtn');
const micBtn = document.getElementById('micBtn');
const passBtn = document.getElementById('passBtn');
const replayBtn = document.getElementById('replayBtn');
const checkBtn = document.getElementById('checkBtn');
const feedbackText = document.getElementById('feedbackText');
const scoreBox = document.getElementById('scoreBox');
const logoutBtn = document.getElementById('logoutBtn');

/* ============================
  Voice helpers (female Hindi)
  ============================ */
function pickHindiFemale(){
  const v = speechSynthesis.getVoices();
  if(!v || v.length===0) return null;
  const hi = v.filter(x => (x.lang||'').toLowerCase().startsWith('hi'));
  const hints = ['female','aditi','shruti','google','ananya','aarya'];
  return hi.find(x => hints.some(h => (x.name||'').toLowerCase().includes(h))) || hi[0] || v[0];
}
function speak(text, onend){
  lastSpoken = text;
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'hi-IN';
    u.rate = 0.95;
    if(!chosenVoice) chosenVoice = pickHindiFemale();
    if(chosenVoice) u.voice = chosenVoice;
    if(onend) u.onend = onend;
    speechSynthesis.speak(u);
  }catch(e){ console.warn("TTS error",e); }
}

/* ============================
  Normalization + matching (tolerant)
  ============================ */
function normalize(s){
  if(!s) return "";
  s = s.toString().normalize('NFD');
  s = s.replace(/[‡§Å‡§Ç]/g,'‡§Ç').replace(/[‡•â‡•ã‡•å]/g,'‡•ã').replace(/[‡•à‡•á]/g,'‡•á')
       .replace(/[‡•É]/g,'‡§∞').replace(/[‡•Ä‡§ø]/g,'‡§ø').replace(/[‡•Ç‡•Å]/g,'‡•Å')
       .replace(/[^\u0900-\u097F]/g,'').replace(/‡•ç+/g,'');
  return s;
}
function levenshtein(a,b){
  if(a===b) return 0;
  const al=a.length, bl=b.length;
  const dp = Array.from({length:al+1}, ()=> Array(bl+1).fill(0));
  for(let i=0;i<=al;i++) dp[i][0]=i;
  for(let j=0;j<=bl;j++) dp[0][j]=j;
  for(let i=1;i<=al;i++){
    for(let j=1;j<=bl;j++){
      dp[i][j] = a[i-1]===b[j-1] ? dp[i-1][j-1] : Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+1);
    }
  }
  return dp[al][bl];
}
function matchAnswer(user, expected){
  const u = normalize(user);
  const e = normalize(expected);
  if(u===e) return true;
  const d = levenshtein(u,e);
  const maxAllowed = Math.max(1, Math.floor(Math.max(u.length,e.length)*0.25));
  return d <= maxAllowed;
}

/* ============================
  Quiz flow
  ============================ */
function showQuestion(){
  if(current >= questions.length) return endQuiz();
  const q = questions[current];
  let prompt, expected;
  if(q.type === 'vachan'){
    prompt = `‡§µ‡§ö‡§® ‡§¨‡§¶‡§≤‡§ø‡§è: ${q.word} ‡§ï‡§æ ‡§¨‡§π‡•Å‡§µ‡§ö‡§® ‡§¨‡§§‡§æ‡§á‡§è`;
    expected = q.answers;
  } else {
    // decide whether ask for ‡§™‡•Å‡§≤‡•ç‡§≤‡§ø‡§Ç‡§ó or ‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä‡§≤‡§ø‡§Ç‡§ó in mixed fashion as before
    const feminineWords = ["‡§∞‡§æ‡§®‡•Ä","‡§∂‡•á‡§∞‡§®‡•Ä","‡§™‡§§‡•ç‡§®‡•Ä","‡§®‡§æ‡§®‡•Ä","‡§Æ‡•Å‡§∞‡•ç‡§ó‡•Ä","‡§™‡•Å‡§§‡•ç‡§∞‡•Ä","‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§™‡§ø‡§ï‡§æ"];
    if(feminineWords.includes(q.word)){
      prompt = `‡§≤‡§ø‡§Ç‡§ó ‡§¨‡§¶‡§≤‡§ø‡§è: ${q.word} ‡§ï‡§æ ‡§™‡•Å‡§≤‡•ç‡§≤‡§ø‡§Ç‡§ó ‡§¨‡§§‡§æ‡§á‡§è`;
      expected = q.male || [q.male];
    } else {
      prompt = `‡§≤‡§ø‡§Ç‡§ó ‡§¨‡§¶‡§≤‡§ø‡§è: ${q.word} ‡§ï‡§æ ‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä‡§≤‡§ø‡§Ç‡§ó ‡§¨‡§§‡§æ‡§á‡§è`;
      expected = q.female || [q.female];
    }
  }
  questions[current]._expected = expected;
  questionText.textContent = prompt;
  answerInput.value = "";
  feedbackText.textContent = "";
  answerInput.disabled = false;
  checkBtn.disabled = false;
  passBtn.disabled = false;
  replayBtn.disabled = false;
  speak(prompt);
}

function handleCorrect(){
  score++;
  feedbackText.style.color = "#1a7f3a";
  feedbackText.textContent = "‚úÖ ‡§∏‡§π‡•Ä ‡§â‡§§‡•ç‡§§‡§∞!";
  speak("‡§∏‡§π‡•Ä ‡§â‡§§‡•ç‡§§‡§∞");
  setTimeout(()=>{ current++; showQuestion(); }, 2000); // 2s after correct
}
function handleWrong(){
  feedbackText.style.color = "#c00";
  feedbackText.textContent = "‚ùå ‡§ó‡§≤‡§§ ‡§â‡§§‡•ç‡§§‡§∞! ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§¨‡•ã‡§≤‡•á‡§Ç ‡§Ø‡§æ ‡§™‡§æ‡§∏ ‡§¶‡§¨‡§æ‡§è‡§Å‡•§";
  speak("‡§ó‡§≤‡§§ ‡§â‡§§‡•ç‡§§‡§∞");
}

/* check typed */
checkBtn.onclick = ()=>{
  const val = answerInput.value.trim();
  if(!val) { feedbackText.textContent = "‡§ï‡•É‡§™‡§Ø‡§æ ‡§â‡§§‡•ç‡§§‡§∞ ‡§¨‡•ã‡§≤‡•á‡§Ç ‡§Ø‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§"; return; }
  const expList = questions[current]._expected || [];
  if(expList.some(x => matchAnswer(val, x))) handleCorrect(); else handleWrong();
};

/* pass */
passBtn.onclick = ()=>{ current++; showQuestion(); };

/* replay */
replayBtn.onclick = ()=>{ if(lastSpoken) speak(lastSpoken); };

/* start */
startBtn.onclick = ()=>{ current = 0; score = 0; shuffle(questions); showQuestion(); };

/* speech recognition with 1s stabilization */
try{
  const R = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(R){
    recognition = new R();
    recognition.lang = "hi-IN";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.onresult = e => {
      setTimeout(()=>{
        const txt = e.results[0][0].transcript.trim();
        answerInput.value = txt;
        const expList = questions[current]._expected || [];
        if(expList.some(x => matchAnswer(txt, x))) handleCorrect(); else handleWrong();
      }, 1000);
    };
    recognition.onerror = ev => { feedbackText.textContent = 'üéôÔ∏è ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + (ev.error||'error'); };
    micBtn.onclick = ()=>{ try{ recognition.start(); }catch(e){} };
  } else {
    micBtn.disabled = true; micBtn.textContent = "‡§Æ‡§æ‡§á‡§ï ‡§®‡§π‡•Ä‡§Ç";
  }
}catch(e){ console.warn(e); micBtn.disabled = true; micBtn.textContent = "‡§Æ‡§æ‡§á‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"; }

/* end quiz */
function endQuiz(){
  questionText.textContent = "‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§!";
  answerInput.disabled = true;
  checkBtn.disabled = passBtn.disabled = micBtn.disabled = replayBtn.disabled = true;
  scoreBox.textContent = `‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§ï‡•ã‡§∞: ${score} / ${questions.length}`;
  speak(`${score} ‡§Æ‡•á‡§Ç ‡§∏‡•á ${questions.length}`);
}

/* ============================
  Login & Apps Script calls
  ============================ */
function postToScript(payload){
  // send POST to Apps Script; content-type text/plain helps some CORS issues
  fetch(SCRIPT_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify(payload)
  }).then(res => res.text()).then(t=> console.log('script response:',t)).catch(err => console.warn('script error',err));
}

/* on login */
loginBtn.onclick = ()=>{
  const name = (loginName.value || "").trim();
  if(!name){ loginMsg.textContent = "‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç"; return; }
  // check if already completed
  if(localStorage.getItem('quiz_done_' + name)){ loginMsg.textContent = "‡§Ü‡§™‡§®‡•á ‡§™‡§π‡§≤‡•á ‡§π‡•Ä ‡§Ø‡§π ‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‡§¶‡•á ‡§¶‡§ø‡§Ø‡§æ ‡§π‡•à‡•§"; return; }
  // mark session
  localStorage.setItem('quiz_user', name);
  // send login to Apps Script
  postToScript({ action: "login", name: name });
  // show quiz UI
  loginBox.style.display = "none";
  quizArea.style.display = "block";
  chosenVoice = pickHindiFemale();
  speechSynthesis.onvoiceschanged = ()=> { chosenVoice = pickHindiFemale(); };
};

/* on logout: send logout info and clear session */
logoutBtn.onclick = ()=>{
  const name = localStorage.getItem('quiz_user') || 'Unknown';
  const attempted = Math.min(current+1, questions.length);
  const payload = {
    action: "logout",
    name: name,
    score: score,
    attempted: attempted,
    remarks: "Completed"
  };
  // send to Apps Script
  postToScript(payload);
  // mark done so they can't retake on same browser
  localStorage.setItem('quiz_done_' + name, JSON.stringify({ score: score, attempted: attempted, at: new Date().toISOString() }));
  // clear session
  localStorage.removeItem('quiz_user');
  // go back to login
  quizArea.style.display = "none";
  loginBox.style.display = "block";
  loginName.value = "";
  loginMsg.textContent = "‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≠‡•á‡§ú‡•Ä ‡§ó‡§Ø‡•Ä (‡§Ø‡§¶‡§ø ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§†‡•Ä‡§ï ‡§•‡§æ)‡•§";
};

/* auto-show login or quiz based on localStorage */
window.onload = ()=>{
  const name = localStorage.getItem('quiz_user');
  if(name && !localStorage.getItem('quiz_done_' + name)){
    // resume session
    loginBox.style.display = "none";
    quizArea.style.display = "block";
    chosenVoice = pickHindiFemale();
    speechSynthesis.onvoiceschanged = ()=> { chosenVoice = pickHindiFemale(); };
  } else {
    loginBox.style.display = "block";
    quizArea.style.display = "none";
  }
};
</script>
</body>
</html>
